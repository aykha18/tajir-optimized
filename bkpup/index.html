<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tailor POS</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@4.1.0/dist/chartjs-chart-matrix.umd.min.js"></script>
  <script defer src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
  <style>
    @keyframes fade-in{0%{opacity:0;transform:translateY(12px);filter:blur(4px)}100%{opacity:1;transform:none;filter:blur(0)}}
    .fade-in{animation:fade-in .45s cubic-bezier(.33,1,.68,1) forwards}
    label{font-size:.7rem;color:#9ca3af}
  </style>
</head>
<body class="min-h-screen bg-neutral-900 text-white font-sans antialiased selection:bg-indigo-600 selection:text-white flex">

  <!-- SIDEBAR -->
  <aside class="w-64 shrink-0 bg-neutral-800/60 backdrop-blur border-r border-neutral-700 flex flex-col rounded-tr-2xl rounded-br-2xl fade-in" style="animation-delay:.05s">
    <div class="flex flex-col items-center pt-6 pb-2">
      <img src="{{ url_for('static', filename='dressme_logo.png') }}" alt="DressMe Logo" class="w-20 h-20 rounded-full object-cover border-2 border-neutral-700 mb-2">
      <h1 class="text-xl font-semibold tracking-tight flex items-center gap-2">
        Tailor POS Pro
    </h1>
    </div>

    <p class="px-6 pt-2 pb-1 text-xs uppercase tracking-wide text-neutral-400">Masters</p>
    <nav class="flex flex-col gap-1 px-4" aria-label="Masters">
      <button data-go="productTypeSec" class="nav-btn flex items-center gap-3 px-3 py-2 rounded-lg focus-visible:ring-2 focus-visible:ring-indigo-400/60 hover:bg-neutral-700 transition">
        <svg data-lucide="layers" class="w-4 h-4"></svg> Product&nbsp;Types
      </button>
      <button data-go="productSec" class="nav-btn flex items-center gap-3 px-3 py-2 rounded-lg focus-visible:ring-2 focus-visible:ring-indigo-400/60 hover:bg-neutral-700 transition">
        <svg data-lucide="box" class="w-4 h-4"></svg> Products
      </button>
      <button data-go="customerSec" class="nav-btn flex items-center gap-3 px-3 py-2 rounded-lg focus-visible:ring-2 focus-visible:ring-indigo-400/60 hover:bg-neutral-700 transition">
        <svg data-lucide="users" class="w-4 h-4"></svg> Customers
      </button>
      <button data-go="vatSec" class="nav-btn flex items-center gap-3 px-3 py-2 rounded-lg focus-visible:ring-2 focus-visible:ring-indigo-400/60 hover:bg-neutral-700 transition">
        <svg data-lucide="percent" class="w-4 h-4"></svg> VAT&nbsp;%
      </button>
      <button data-go="employeeSec" class="nav-btn flex items-center gap-3 px-3 py-2 rounded-lg focus-visible:ring-2 focus-visible:ring-indigo-400/60 hover:bg-neutral-700 transition">
        <svg data-lucide="user-cog" class="w-4 h-4"></svg> Employees
      </button>
      <button data-go="settingsSec" class="nav-btn flex items-center gap-3 px-3 py-2 rounded-lg focus-visible:ring-2 focus-visible:ring-indigo-400/60 hover:bg-neutral-700 transition">
        <svg data-lucide="settings" class="w-4 h-4"></svg> Settings
      </button>
    </nav>

    <div class="border-t border-neutral-700 my-4"></div>

    <p class="px-6 pt-2 pb-1 text-xs uppercase tracking-wide text-neutral-400">Operations</p>
    <nav class="flex flex-col gap-1 px-4 mb-auto" aria-label="Operations">
      <button data-go="billingSec" class="nav-btn flex items-center gap-3 px-3 py-2 rounded-lg focus-visible:ring-2 focus-visible:ring-indigo-400/60 hover:bg-neutral-700 transition">
        <svg data-lucide="file-text" class="w-4 h-4"></svg> Billing
      </button>
      <button data-go="dashSec" class="nav-btn flex items-center gap-3 px-3 py-2 rounded-lg focus-visible:ring-2 focus-visible:ring-indigo-400/60 hover:bg-neutral-700 transition">
        <svg data-lucide="bar-chart-3" class="w-4 h-4"></svg> Dashboard
      </button>
    </nav>

    <p class="px-6 py-4 border-t border-neutral-700 text-xs text-neutral-400">Â© 2024</p>
  </aside>

  <!-- MAIN -->
  <main class="flex-1 overflow-y-auto fade-in" style="animation-delay:.12s">
    <header class="sticky top-0 z-10 bg-neutral-900/80 backdrop-blur border-b border-neutral-800 rounded-bl-2xl">
      <div class="max-w-6xl mx-auto px-6 py-4 flex items-center justify-between">
        <h2 id="pageTitle" class="text-lg font-semibold tracking-tight">Billing</h2>
        <div class="flex items-center gap-4">
          <button id="darkToggle" class="p-2 rounded-lg border border-neutral-700 hover:bg-neutral-800 focus-visible:ring-2 focus-visible:ring-indigo-400/60">
            <svg data-lucide="moon" class="w-4 h-4"></svg>
          </button>
          <img src="https://images.unsplash.com/photo-1599566150163-29194dcaad36?auto=format&fit=crop&w=64&q=80" alt="avatar" class="w-8 h-8 rounded-full object-cover border border-neutral-700">
        </div>
      </div>
    </header>

    <!-- CONTENT -->
    <div class="max-w-6xl mx-auto py-10 px-6 space-y-20">

      <!-- PRODUCT TYPES -->
      <section id="productTypeSec" class="page hidden space-y-6">
        <h3 class="text-2xl font-semibold tracking-tight">Create Product Type</h3>
        <form id="productTypeForm" class="grid grid-cols-12 gap-4">
          <div class="col-span-9 flex flex-col">
            <label for="productTypeName">Type Name</label>
            <input id="productTypeName" placeholder="e.g. Shirt" required class="bg-neutral-900/70 border border-neutral-700 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-400/60">
          </div>
          <button class="col-span-3 bg-indigo-600 hover:bg-indigo-500 active:scale-95 transition rounded-lg text-sm font-medium py-2 self-end">Add/Update</button>
        </form>
        <ul id="productTypeList" class="text-sm divide-y divide-neutral-800 border border-neutral-700 rounded-lg overflow-hidden" aria-live="polite"></ul>
      </section>

      <!-- PRODUCTS -->
      <section id="productSec" class="page hidden space-y-6">
        <h3 class="text-2xl font-semibold tracking-tight">Create / Modify Product</h3>
        <input type="text" id="productSearch" placeholder="Search products by name or type..." class="bg-neutral-900/70 border border-neutral-700 text-white rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-400/60 mb-2 w-full max-w-md">
        <div id="productResults"></div>
        <form id="productForm" class="grid grid-cols-12 gap-4">
          <div class="col-span-3 flex flex-col">
            <label for="productTypeSelect">Product Type</label>
            <select id="productTypeSelect" required class="bg-neutral-900/70 border border-neutral-700 rounded-lg px-2 py-2 text-sm focus:ring-2 focus:ring-indigo-400/60">
              <option hidden selected>Select type</option>
            </select>
          </div>
          <div class="col-span-5 flex flex-col">
            <label for="productName">Product Name</label>
            <input id="productName" placeholder="e.g. Linen Shirt" required class="bg-neutral-900/70 border border-neutral-700 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-400/60">
          </div>
          <div class="col-span-2 flex flex-col">
            <label for="productPrice">Price (AED)</label>
            <input id="productPrice" type="number" min="0" step=".01" placeholder="0.00" required class="bg-neutral-900/70 border border-neutral-700 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-400/60">
          </div>
          <button class="col-span-2 bg-indigo-600 hover:bg-indigo-500 active:scale-95 transition rounded-lg text-sm font-medium py-2 self-end">Add/Update</button>
        </form>
        <table id="productTable" class="min-w-full text-sm border border-neutral-700 rounded-lg overflow-hidden">
          <thead class="bg-neutral-800/70"><tr><th class="px-3 py-2 text-left font-medium">Type</th><th class="px-3 py-2 text-left font-medium">Name</th><th class="px-3 py-2 text-left font-medium">Price</th><th class="px-3 py-2 text-left font-medium">Actions</th></tr></thead>
          <tbody class="divide-y divide-neutral-800"></tbody>
        </table>
      </section>

      <!-- CUSTOMERS -->
      <section id="customerSec" class="page hidden space-y-6">
        <h3 class="text-2xl font-semibold tracking-tight">Customer Master</h3>
        <input type="text" id="customerSearch" placeholder="Search customers by name or phone..." class="bg-neutral-900/70 border border-neutral-700 text-white rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-400/60 mb-2 w-full max-w-md">
        <div id="customerResults"></div>
        <form id="customerForm" class="grid grid-cols-12 gap-4">
          <div class="col-span-4 flex flex-col"><label for="customerName">Name</label><input id="customerName" placeholder="Customer name" required class="bg-neutral-900/70 border border-neutral-700 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-400/60"></div>
          <div class="col-span-3 flex flex-col"><label for="customerPhone">Phone</label><input id="customerPhone" placeholder="e.g. 9876543210" required class="bg-neutral-900/70 border border-neutral-700 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-400/60"></div>
          <div class="col-span-3 flex flex-col"><label for="customerCity">City</label><input id="customerCity" placeholder="City" class="bg-neutral-900/70 border border-neutral-700 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-400/60"></div>
          <div class="col-span-2 flex flex-col"><label for="customerArea">Area</label><input id="customerArea" placeholder="Area" class="bg-neutral-900/70 border border-neutral-700 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-400/60"></div>
          <button class="col-span-2 bg-indigo-600 hover:bg-indigo-500 active:scale-95 transition rounded-lg text-sm font-medium py-2 self-end">Add/Update</button>
        </form>
        <ul id="customerList" class="text-sm divide-y divide-neutral-800 border border-neutral-700 rounded-lg overflow-hidden" aria-live="polite"></ul>
      </section>

      <!-- VAT MASTER -->
      <section id="vatSec" class="page hidden space-y-6">
        <h3 class="text-2xl font-semibold tracking-tight">VAT % Master</h3>
        <form id="vatForm" class="grid grid-cols-12 gap-4">
          <div class="col-span-3 flex flex-col"><label for="vatRate">VAT&nbsp;%</label><input id="vatRate" type="number" min="0" step=".01" value="5" required class="bg-neutral-900/70 border border-neutral-700 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-400/60"></div>
          <div class="col-span-3 flex flex-col"><label for="vatEffDate">Effective From</label><input id="vatEffDate" type="date" required class="bg-neutral-900/70 border border-neutral-700 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-400/60"></div>
          <div class="col-span-3 flex flex-col"><label for="vatToDate">To Date</label><input id="vatToDate" type="date" required class="bg-neutral-900/70 border border-neutral-700 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-400/60"></div>
          <button class="col-span-3 bg-indigo-600 hover:bg-indigo-500 active:scale-95 transition rounded-lg text-sm font-medium py-2 self-end">Add Row</button>
        </form>
        <table id="vatTable" class="min-w-full text-sm border border-neutral-700 rounded-lg overflow-hidden">
          <thead class="bg-neutral-800/70"><tr><th class="px-3 py-2 text-left font-medium">VAT&nbsp;%</th><th class="px-3 py-2 text-left font-medium">From</th><th class="px-3 py-2 text-left font-medium">To</th></tr></thead>
          <tbody class="divide-y divide-neutral-800"></tbody>
        </table>
      </section>

      <!-- EMPLOYEES -->
      <section id="employeeSec" class="page hidden space-y-6">
        <h3 class="text-2xl font-semibold tracking-tight">Employees</h3>
        <form id="employeeForm" class="grid grid-cols-12 gap-4">
          <div class="col-span-4 flex flex-col"><label for="employeeName">Name</label><input id="employeeName" placeholder="Employee name" required class="bg-neutral-900/70 border border-neutral-700 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-400/60"></div>
          <div class="col-span-4 flex flex-col"><label for="employeeMobile">Mobile</label><input id="employeeMobile" placeholder="e.g. 0501234567" class="bg-neutral-900/70 border border-neutral-700 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-400/60"></div>
          <div class="col-span-4 flex flex-col"><label for="employeeAddress">Address</label><input id="employeeAddress" placeholder="Address" class="bg-neutral-900/70 border border-neutral-700 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-400/60"></div>
          <button class="col-span-2 bg-indigo-600 hover:bg-indigo-500 active:scale-95 transition rounded-lg text-sm font-medium py-2 self-end">Add/Update</button>
        </form>
        <ul id="employeeList" class="text-sm divide-y divide-neutral-800 border border-neutral-700 rounded-lg overflow-hidden" aria-live="polite"></ul>
      </section>

      <!-- SETTINGS -->
      <section id="settingsSec" class="page hidden space-y-6">
        <h3 class="text-2xl font-semibold tracking-tight">Backup & Restore</h3>
        <div class="flex gap-4 mb-4">
          <button id="backupBtn" class="bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg px-4 py-2 font-medium">Backup Now</button>
          <label class="bg-neutral-700 hover:bg-neutral-600 text-white rounded-lg px-4 py-2 font-medium cursor-pointer">
            Restore...
            <input id="restoreInput" type="file" accept=".zip" class="hidden">
          </label>
        </div>
        <h4 class="text-lg font-semibold mb-2">Backup History</h4>
        <table class="min-w-full text-sm border border-neutral-700 rounded-lg overflow-hidden">
          <thead class="bg-neutral-800/70"><tr><th class="px-3 py-2 text-left font-medium">Date</th><th class="px-3 py-2 text-left font-medium">File</th><th class="px-3 py-2 text-left font-medium">Actions</th></tr></thead>
          <tbody id="backupTableBody" class="divide-y divide-neutral-800"></tbody>
        </table>
      </section>

      <!-- BILLING -->
      <section id="billingSec" class="page space-y-6">
        <h3 class="text-2xl font-semibold tracking-tight">Billing</h3>
        <button id="searchInvoiceBtn" class="bg-neutral-700 hover:bg-neutral-600 text-white rounded-lg px-4 py-2 mb-4">Search & Reprint Invoice</button>
        <div id="searchInvoiceModal" class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 hidden">
          <div class="bg-neutral-900 p-6 rounded-lg w-full max-w-2xl">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-semibold">Search Invoice</h3>
              <button id="closeSearchInvoice" class="text-neutral-400 hover:text-white text-xl">&times;</button>
            </div>
            <input id="searchInvoiceInput" type="text" placeholder="Invoice #, Customer Name, or Phone" class="w-full mb-4 px-3 py-2 rounded bg-neutral-800 border border-neutral-700 text-white">
            <div id="searchInvoiceResults" class="max-h-64 overflow-y-auto"></div>
          </div>
        </div>

        <!-- META -->
        <form id="billingForm" class="space-y-6">
          <div class="grid grid-cols-12 gap-4">
            <div class="col-span-3 flex flex-col"><label for="billNumber">Bill&nbsp;#</label><input id="billNumber" placeholder="Auto / Manual" class="bg-neutral-900/70 border border-neutral-700 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-400/60"></div>
            <div class="col-span-3 flex flex-col"><label for="billMobile">Mobile</label><input id="billMobile" placeholder="Mobile no." class="bg-neutral-900/70 border border-neutral-700 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-400/60"></div>
            <div class="col-span-3 flex flex-col"><label for="billCustomer">Customer</label><input id="billCustomer" placeholder="Customer name" class="bg-neutral-900/70 border border-neutral-700 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-400/60"></div>
            <div class="col-span-3 flex flex-col"><label for="paymentMethod">Payment Method</label><select id="paymentMethod" class="bg-neutral-900/70 border border-neutral-700 rounded-lg px-2 py-2 text-sm focus:ring-2 focus:ring-indigo-400/60"><option>Cash</option><option>Card</option></select></div>
            <div class="col-span-3 flex flex-col"><label for="masterName">Master</label><input id="masterName" placeholder="Master name" autocomplete="off" class="bg-neutral-900/70 border border-neutral-700 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-400/60"></div>
            <div class="col-span-3 flex flex-col"><label for="trialDate">Trial Date</label><input id="trialDate" type="date" class="bg-neutral-900/70 border border-neutral-700 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-400/60"></div>
            <div class="col-span-3 flex flex-col"><label for="billDate">Bill Date</label><input id="billDate" type="date" class="bg-neutral-900/70 border border-neutral-700 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-400/60"></div>
            <div class="col-span-3 flex flex-col"><label for="deliveryDate">Delivery Date</label><input id="deliveryDate" type="date" class="bg-neutral-900/70 border border-neutral-700 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-400/60"></div>
            <div class="col-span-3 flex flex-col"><label for="billCity">City</label><input id="billCity" placeholder="City" class="bg-neutral-900/70 border border-neutral-700 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-400/60"></div>
            <div class="col-span-3 flex flex-col"><label for="billArea">Area</label><input id="billArea" placeholder="Area" class="bg-neutral-900/70 border border-neutral-700 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-400/60"></div>
          </div>

          <!-- ITEM ENTRY -->
          <div class="grid grid-cols-12 gap-4">
            <div class="col-span-3 flex flex-col"><label for="billProduct">Product</label><select id="billProduct" required class="bg-neutral-900/70 border border-neutral-700 rounded-lg px-2 py-2 text-sm focus:ring-2 focus:ring-indigo-400/60"><option hidden selected>Select product</option></select></div>
            <div class="col-span-2 flex flex-col"><label for="billRate">Rate&nbsp;(AED)</label><input id="billRate" type="number" min="0" step=".01" placeholder="0.00" required class="bg-neutral-900/70 border border-neutral-700 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-400/60"></div>
            <div class="col-span-1 flex flex-col"><label for="billQty">Qty</label><input id="billQty" type="number" min="1" value="1" required class="bg-neutral-900/70 border border-neutral-700 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-400/60"></div>
            <div class="col-span-2 flex flex-col"><label for="billDiscount">Discount&nbsp;(AED)</label><input id="billDiscount" type="number" min="0" step=".01" value="0" class="bg-neutral-900/70 border border-neutral-700 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-400/60"></div>
            <div class="col-span-2 flex flex-col"><label for="billAdvPaid">Advance&nbsp;(AED)</label><input id="billAdvPaid" type="number" min="0" value="0" class="bg-neutral-900/70 border border-neutral-700 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-400/60"></div>
            <div class="col-span-1 flex flex-col"><label for="vatPercent">VAT&nbsp;%</label><input id="vatPercent" type="number" min="0" step=".01" value="5" class="bg-neutral-900/70 border border-neutral-700 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-400/60"></div>
            <button id="addItemBtn" class="col-span-1 bg-indigo-600 hover:bg-indigo-500 active:scale-95 transition rounded-lg text-sm font-medium py-2 self-end">Add</button>
          </div>
        </form>

        <table id="billTable" class="min-w-full text-sm border border-neutral-700 rounded-lg overflow-hidden">
          <thead class="bg-neutral-800/70"><tr><th class="px-3 py-2 text-left font-medium">Product</th><th class="px-3 py-2 text-left font-medium">Qty</th><th class="px-3 py-2 text-left font-medium">Rate</th><th class="px-3 py-2 text-left font-medium">Discount</th><th class="px-3 py-2 text-left font-medium">Advance</th><th class="px-3 py-2 text-left font-medium">Total</th><th class="px-3 py-2 text-left font-medium">Actions</th></tr></thead>
          <tbody class="divide-y divide-neutral-800"></tbody>
        </table>

        <div class="flex flex-wrap items-center justify-between gap-6 text-sm">
          <div class="flex gap-12">
            <div class="flex gap-4"><span class="text-neutral-400">Subtotal:</span><span id="subTotal" class="font-semibold tracking-tight">AED&nbsp;0</span></div>
            <div class="flex gap-4"><span class="text-neutral-400">VAT:</span><span id="vatAmount" class="font-semibold tracking-tight">AED&nbsp;0</span></div>
            <div class="flex gap-4"><span class="text-neutral-400">Amount Due:</span><span id="amountDue" class="font-semibold tracking-tight">AED&nbsp;0</span></div>
          </div>
          <button id="printBtn" disabled class="flex items-center gap-2 bg-indigo-600/40 text-white/60 px-4 py-2 rounded-lg font-medium opacity-50 pointer-events-none focus-visible:ring-2 focus-visible:ring-indigo-400/60 transition">
            <svg data-lucide="printer" class="w-4 h-4"></svg> Print Receipt
          </button>
        </div>
      </section>

      <!-- DASHBOARD -->
      <section id="dashSec" class="page hidden space-y-6">
        <div class="flex justify-between items-center">
        <h3 class="text-2xl font-semibold tracking-tight">Analytics Dashboard</h3>
          <button id="refreshDashboardBtn" class="bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg px-4 py-2 text-sm font-medium">
            <svg data-lucide="refresh-cw" class="w-4 h-4 inline mr-2"></svg> Refresh
          </button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
          <div class="bg-neutral-800/60 p-6 rounded-lg border border-neutral-700">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-neutral-400">Today's Revenue</p>
                <p id="todayRevenue" class="text-2xl font-bold text-indigo-400">AED 0</p>
              </div>
              <!-- Dirham (AED) symbol: D with two horizontal bars crossing through -->
              <svg class="w-8 h-8 text-indigo-500" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                <g stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <!-- Vertical line -->
                  <path d="M10 6v20" />
                  <!-- D bowl -->
                  <path d="M10 6c10 0 10 20 0 20" />
                  <!-- Two horizontal bars crossing through the D -->
                  <path d="M6 12h16" />
                  <path d="M6 20h16" />
                </g>
              </svg>
            </div>
          </div>
          <div class="bg-neutral-800/60 p-6 rounded-lg border border-neutral-700">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-neutral-400">Today's Bills</p>
                <p id="todayBills" class="text-2xl font-bold text-green-400">0</p>
              </div>
              <svg data-lucide="file-text" class="w-8 h-8 text-green-500"></svg>
            </div>
          </div>
          <div class="bg-neutral-800/60 p-6 rounded-lg border border-neutral-700">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-neutral-400">Pending Bills</p>
                <p id="pendingBills" class="text-2xl font-bold text-yellow-400">0</p>
              </div>
              <svg data-lucide="clock" class="w-8 h-8 text-yellow-500"></svg>
            </div>
          </div>
          <div class="bg-neutral-800/60 p-6 rounded-lg border border-neutral-700">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-neutral-400">Total Customers</p>
                <p id="totalCustomers" class="text-2xl font-bold text-blue-400">0</p>
              </div>
              <svg data-lucide="users" class="w-8 h-8 text-blue-500"></svg>
            </div>
          </div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Monthly Revenue Chart (Vertical Bar with Effects) -->
          <div class="bg-neutral-800/60 p-6 rounded-lg border border-neutral-700" style="min-height:340px;">
            <h4 class="text-lg font-semibold mb-4">Monthly Revenue</h4>
            <div style="height:260px;"><canvas id="revenueChart"></canvas></div>
          </div>
          <!-- Top Regions Chart -->
          <div class="bg-neutral-800/60 p-6 rounded-lg border border-neutral-700" style="min-height:340px;">
            <h4 class="text-lg font-semibold mb-4">Top Regions by Sales</h4>
            <div style="height:260px;"><canvas id="regionsChart"></canvas></div>
          </div>
          <!-- Trending Products -->
          <div class="bg-neutral-800/60 p-6 rounded-lg border border-neutral-700" style="min-height:340px;">
            <h4 class="text-lg font-semibold mb-4">Trending Products</h4>
            <div style="height:260px;"><canvas id="trendingProductsChart"></canvas></div>
          </div>
          <!-- Repeated Customers Bar Chart -->
          <div class="bg-neutral-800/60 p-6 rounded-lg border border-neutral-700" style="min-height:340px;">
            <h4 class="text-lg font-semibold mb-4">Most Repeated Customers</h4>
            <div style="height:260px;"><canvas id="repeatedCustomersChart"></canvas></div>
          </div>
          <!-- Top 5 Employees by Revenue Bar Chart -->
          <div class="bg-neutral-800/60 p-6 rounded-lg border border-neutral-700" style="min-height:340px;">
            <h4 class="text-lg font-semibold mb-4">Top 5 Employees by Revenue</h4>
            <div style="height:260px;"><canvas id="employeeBarChart"></canvas></div>
          </div>
          <!-- Revenue Share by Employee Pie Chart -->
          <div class="bg-neutral-800/60 p-6 rounded-lg border border-neutral-700" style="min-height:340px;">
            <h4 class="text-lg font-semibold mb-4">Revenue Share by Employee</h4>
            <div style="height:260px;"><canvas id="employeePieChart"></canvas></div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- SCRIPTS -->
  <script>
    // Define $ helper at the very top for global use
    const $ = id => document.getElementById(id);
    // Define vats at the top for global use
    const vats = [];
    // Define bill and printBtn at the top
    const bill = [];
    let printBtn;
    // At the top of your script, ensure this variable exists:
    let editingProductId = null;
    // At the top of your script, ensure this variable exists:
    let editingCustomerId = null;

    // Define activeVatRate before togglePrint and updateTotals
    function activeVatRate(iso) {
      const hit = vats.find(v => iso >= v.effective_from && iso <= v.effective_to);
      return hit ? hit.rate_percentage : parseFloat($('vatPercent').value) || 0;
    }

    function togglePrint() {
      
      const enabled = bill.length > 0;
      printBtn.disabled = !enabled;
      printBtn.classList.toggle('opacity-50', !enabled);
      printBtn.classList.toggle('pointer-events-none', !enabled);
      printBtn.classList.toggle('bg-indigo-600/40', !enabled);
      printBtn.classList.toggle('text-white/60', !enabled);
      printBtn.classList.toggle('bg-indigo-600', enabled);
      printBtn.classList.toggle('text-white', enabled);
      printBtn.classList.toggle('hover:bg-indigo-500', enabled);
    }

    function updateTotals() {
      const sub = bill.reduce((s, i) => s + i.total, 0),
            vatPct = activeVatRate($('billDate').value),
            vatAmt = sub * vatPct / 100,
            due = sub + vatAmt;
      $('subTotal').textContent = `AED ${sub.toFixed(2)}`;
      $('vatAmount').textContent = `AED ${vatAmt.toFixed(2)}`;
      $('amountDue').textContent = `AED ${due.toFixed(2)}`;
      $('vatPercent').value = vatPct.toFixed(2);
      togglePrint();
    }

    document.addEventListener('DOMContentLoaded',()=>{
      lucide.createIcons({nameAttr:'data-lucide'});
      printBtn = document.getElementById('printBtn');
      

      /* NAV + FADE */
      const navBtns=[...document.querySelectorAll('.nav-btn')],pages=[...document.querySelectorAll('.page')];
      navBtns.forEach((b,i)=>{b.style.opacity=0;b.style.transform='translateX(-8px)';setTimeout(()=>b.classList.add('fade-in'),80+i*60);});
      navBtns.forEach(btn=>btn.addEventListener('click',()=>{
        navBtns.forEach(b=>b.classList.remove('bg-neutral-700','ring-2','ring-indigo-500/60'));
        btn.classList.add('bg-neutral-700','ring-2','ring-indigo-500/60');
        pages.forEach(p=>p.classList.add('hidden'));
        const page=$(btn.dataset.go);page.classList.remove('hidden');page.classList.add('fade-in');
        setTimeout(()=>page.classList.remove('fade-in'),450);
        $('pageTitle').textContent=page.querySelector('h3').textContent;
      }));
      /* Set Billing as default */
      document.querySelector('.nav-btn[data-go="billingSec"]').addEventListener('click', async () => {
        // Only generate Bill # if the field is empty or not manually changed
        if (!$('billNumber').dataset.userEdited) {
          const resp = await fetch('/api/next-bill-number');
          if (resp.ok) {
            const data = await resp.json();
            if (data && data.bill_number) {
              $('billNumber').value = data.bill_number;
            }
          }
        }
      });
      // Mark Bill # as user-edited if changed
      $('billNumber').addEventListener('input', function() {
        this.dataset.userEdited = '1';
      });
      // On initial load, also generate Bill #
      (async function() {
        if (!$('billNumber').dataset.userEdited) {
          const resp = await fetch('/api/next-bill-number');
          if (resp.ok) {
            const data = await resp.json();
            if (data && data.bill_number) {
              $('billNumber').value = data.bill_number;
            }
          }
        }
      })();

      /* DEFAULT DATES */
      const todayIso=()=>new Date().toISOString().split('T')[0];
      $('billDate').value=todayIso();
      const del=new Date();del.setDate(del.getDate()+3);$('deliveryDate').value=del.toISOString().split('T')[0];
      $('trialDate').value = $('deliveryDate').value;
      $('vatEffDate').value='2018-01-01';$('vatToDate').value=todayIso();
      
      // Set Dubai as default city
      $('billCity').value = 'Dubai';

      /* STORES */
      const types=[],prods=[],customers=[],employees=[];
      const option=(v,t)=>`<option value="${v}">${t}</option>`;

      /* API FUNCTIONS */
      const apiCall = async (url, options = {}) => {
        try {
          const response = await fetch(url, {
            headers: {
              'Content-Type': 'application/json',
              ...options.headers
            },
            ...options
          });
          return await response.json();
        } catch (error) {
          console.error('API Error:', error);
          return null;
        }
      };

      /* LOAD DATA */
      const loadData = async () => {
        // Load product types
        const typesData = await apiCall('/api/product-types');
        if (typesData) {
          types.length = 0;
          types.push(...typesData);
          renderTypeList();
          renderTypeOptions();
        }

        // Load products
        const prodsData = await apiCall('/api/products');
        if (prodsData) {
          prods.length = 0;
          prods.push(...prodsData);
          renderProdTable();
          renderProdOptions();
        }

        // Load customers
        const customersData = await apiCall('/api/customers');
        if (customersData) {
          customers.length = 0;
          customers.push(...customersData);
          renderCustomerList();
          window.customers = customers; // Store customers globally
  
        }

        // Load VAT rates
        const vatsData = await apiCall('/api/vat-rates');
        if (vatsData) {
          vats.length = 0;
          vats.push(...vatsData);
          renderVatTable();
          updateTotals();
        }

        // Load employees
        const employeesData = await apiCall('/api/employees');
        if (employeesData) {
          employees.length = 0;
          employees.push(...employeesData);
          renderEmployeeList();
        }

        // Load dashboard data
        loadDashboardData();
      };

      /* LOAD DASHBOARD DATA */
      const loadDashboardData = async () => {
        try {
          // Show loading state
          const refreshBtn = $('refreshDashboardBtn');
          const originalText = refreshBtn.innerHTML;
          refreshBtn.innerHTML = '<svg data-lucide="loader-2" class="w-4 h-4 inline mr-2 animate-spin"></svg> Loading...';
          refreshBtn.disabled = true;
          
          const dashboardData = await apiCall('/api/dashboard');
          if (dashboardData) {
            // Update summary cards
            $('todayRevenue').textContent = `AED ${parseFloat(dashboardData.total_revenue || 0).toFixed(2)}`;
            $('todayBills').textContent = dashboardData.total_bills_today || 0;
            $('pendingBills').textContent = dashboardData.pending_bills || 0;
            $('totalCustomers').textContent = dashboardData.total_customers || 0;

            // Create charts
            createRevenueChart(dashboardData.monthly_revenue || []);
            createRegionsChart(dashboardData.top_regions || []);
            createTrendingProductsChart(dashboardData.trending_products || []);
            createRepeatedCustomersChart(dashboardData.repeated_customers || []);
            
            // Load employee analytics
            const empAnalytics = await apiCall('/api/employee-analytics');
            if (empAnalytics) {
              createEmployeeBarChart(empAnalytics.top5 || []);
              createEmployeePieChart(empAnalytics.shares || []);
            }
            
    
          } else {
            console.error('No dashboard data received');
          }
        } catch (error) {
          console.error('Error loading dashboard data:', error);
          // Show error state
          $('todayRevenue').textContent = 'Error';
          $('todayBills').textContent = 'Error';
          $('pendingBills').textContent = 'Error';
          $('totalCustomers').textContent = 'Error';
        } finally {
          // Restore button state
          const refreshBtn = $('refreshDashboardBtn');
          refreshBtn.innerHTML = '<svg data-lucide="refresh-cw" class="w-4 h-4 inline mr-2"></svg> Refresh';
          refreshBtn.disabled = false;
          lucide.createIcons(); // Recreate icons after DOM changes
        }
      };

      /* DASHBOARD CHARTS */
      // Monthly Revenue Chart (Vertical Bar with Effects)
      function createRevenueChart(data) {
        const ctx = document.getElementById('revenueChart');
        if (!ctx) return;
        if (window.revenueChart && typeof window.revenueChart.destroy === 'function') window.revenueChart.destroy();
        const labels = data.map(item => {
          const [year, month] = item.month.split('-');
          return new Date(year, month - 1).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
        });
        const values = data.map(item => parseFloat(item.revenue || 0));
        // Create a gradient for the bars
        const gradient = ctx.getContext('2d').createLinearGradient(0, 0, 0, 260);
        gradient.addColorStop(0, '#6366f1');
        gradient.addColorStop(0.5, '#8b5cf6');
        gradient.addColorStop(1, '#06b6d4');
        window.revenueChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'Revenue (AED)',
              data: values,
              backgroundColor: gradient,
              borderRadius: 8,
              borderWidth: 2,
              borderColor: '#fff',
              hoverBackgroundColor: '#a5b4fc',
              hoverBorderColor: '#6366f1',
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: ctx => `AED ${Number(ctx.raw).toLocaleString()}`
                }
              }
            },
            // Remove indexAxis: 'y' for vertical bars
            scales: {
              y: { beginAtZero: true, ticks: { color: '#9ca3af' }, grid: { color: 'rgba(255,255,255,0.1)' } },
              x: { ticks: { color: '#9ca3af' }, grid: { color: 'rgba(255,255,255,0.1)' } }
            }
          }
        });
      }

      const createRegionsChart = (data) => {
        const ctx = document.getElementById('regionsChart');
        if (!ctx) return;
        
        // Destroy existing chart if it exists and is a Chart instance
        if (window.regionsChart && typeof window.regionsChart.destroy === 'function') {
          window.regionsChart.destroy();
        }

        const labels = data.map(item => item.area || 'Unknown');
        const values = data.map(item => parseFloat(item.sales || 0));

        window.regionsChart = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: labels,
            datasets: [{
              data: values,
              backgroundColor: [
                '#8b5cf6', '#06b6d4', '#10b981', '#f59e0b', '#ef4444',
                '#84cc16', '#f97316', '#ec4899', '#6366f1', '#14b8a6'
              ],
              hoverOffset: 24, // 3D pop-out effect
              offset: 4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom',
                labels: {
                  color: '#9ca3af',
                  padding: 10
                }
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const label = context.label || '';
                    const value = context.parsed || 0;
                    return `${label}: AED ${value.toLocaleString()}`;
                  }
                }
              }
            }
          }
        });
      };

      const createTrendingProductsChart = (data) => {
        const ctx = document.getElementById('trendingProductsChart');
        if (!ctx) return;
        
        // Destroy existing chart if it exists and is a Chart instance
        if (window.trendingProductsChart && typeof window.trendingProductsChart.destroy === 'function') {
          window.trendingProductsChart.destroy();
        }

        const labels = data.map(item => item.product_name || 'Unknown');
        const values = data.map(item => parseInt(item.qty_sold || 0));
        const revenues = data.map(item => parseFloat(item.total_revenue || 0));

        window.trendingProductsChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'Quantity Sold',
              data: values,
              backgroundColor: '#8b5cf6',
              borderRadius: 4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                callbacks: {
                  title: function(context) {
                    return context[0].label;
                  },
                  label: function(context) {
                    const idx = context.dataIndex;
                    const qty = values[idx];
                    const revenue = revenues[idx];
                    return [`${qty} sold`, `Total Revenue: AED ${revenue.toLocaleString()}`];
                  }
                }
              }
            },
            scales: {
              x: {
                beginAtZero: true,
                grid: {
                  color: 'rgba(255, 255, 255, 0.1)'
                },
                ticks: {
                  color: '#9ca3af'
                }
              },
              y: {
                grid: {
                  color: 'rgba(255, 255, 255, 0.1)'
                },
                ticks: {
                  color: '#9ca3af'
                }
              }
            }
          }
        });
      };

      // Replace createRepeatedCustomersList with a bar chart
      const createRepeatedCustomersChart = (data) => {
        const ctx = document.getElementById('repeatedCustomersChart');
        if (!ctx) return;
        // Destroy existing chart if it exists and is a Chart instance
        if (window.repeatedCustomersChart && typeof window.repeatedCustomersChart.destroy === 'function') {
          window.repeatedCustomersChart.destroy();
        }
        // Prepare data
        const labels = data.map(item => item.customer_name || 'Unknown');
        const invoiceCounts = data.map(item => item.invoice_count || 0);
        const revenues = data.map(item => parseFloat(item.total_revenue || 0));
        window.repeatedCustomersChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'Invoices',
              data: invoiceCounts,
              backgroundColor: '#06b6d4',
              borderRadius: 4,
              maxBarThickness: 32
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  title: function(context) {
                    // Show only the customer name as the tooltip title
                    return context[0].label;
                  },
                  label: function(context) {
                    const idx = context.dataIndex;
                    const invoices = invoiceCounts[idx];
                    const revenue = revenues[idx];
                    return [`${invoices} invoices`, `Total Revenue: AED ${revenue.toLocaleString()}`];
                  }
                }
              }
            },
            scales: {
              x: {
                beginAtZero: true,
                grid: { color: 'rgba(255,255,255,0.1)' },
                ticks: { color: '#9ca3af' }
              },
              y: {
                grid: { color: 'rgba(255,255,255,0.1)' },
                ticks: { color: '#9ca3af' }
              }
            }
          }
        });
      };

      // Employee Bar Chart (Top 5 by Revenue)
      function createEmployeeBarChart(data) {

        const ctx = document.getElementById('employeeBarChart');
        if (!ctx) return;
        if (window.employeeBarChart && typeof window.employeeBarChart.destroy === 'function') window.employeeBarChart.destroy();
        const labels = data.map(e => e.name || 'Unknown');
        const values = data.map(e => Number(e.total_revenue) || 0); // Ensure numeric
        window.employeeBarChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'Revenue (AED)',
              data: values,
              backgroundColor: '#f59e0b',
              borderRadius: 6,
              borderWidth: 2,
              borderColor: '#fff',
              hoverBackgroundColor: '#fbbf24',
              hoverBorderColor: '#f59e0b',
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: ctx => `AED ${Number(ctx.raw).toLocaleString()}`
                }
              }
            },
            indexAxis: 'y',
            scales: {
              x: { beginAtZero: true, ticks: { color: '#9ca3af' }, grid: { color: 'rgba(255,255,255,0.1)' } },
              y: { ticks: { color: '#9ca3af' }, grid: { color: 'rgba(255,255,255,0.1)' } }
            }
          }
        });
      }
      // Employee Pie Chart (Revenue Share)
      function createEmployeePieChart(data) {
        const ctx = document.getElementById('employeePieChart');
        if (!ctx) return;
        if (window.employeePieChart && typeof window.employeePieChart.destroy === 'function') window.employeePieChart.destroy();
        const labels = data.map(e => e.name || 'Unknown');
        const values = data.map(e => parseFloat(e.total_revenue || 0));
        window.employeePieChart = new Chart(ctx, {
          type: 'pie',
          data: {
            labels: labels,
            datasets: [{
              data: values,
              backgroundColor: [
                '#8b5cf6', '#06b6d4', '#10b981', '#f59e0b', '#ef4444',
                '#84cc16', '#f97316', '#ec4899', '#6366f1', '#14b8a6'
              ],
              hoverOffset: 24, // 3D pop-out effect
              offset: 4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom', labels: { color: '#9ca3af', padding: 10 } },
              tooltip: {
                callbacks: {
                  label: ctx => `${ctx.label}: AED ${ctx.parsed.toLocaleString()}`
                }
              }
            }
          }
        });
      }

      /* HELPERS */
      // const activeVatRate=iso=>{
      //   const hit=vats.find(v=>iso>=v.effective_from&&iso<=v.effective_to);
      //   return hit?hit.rate_percentage:parseFloat($('vatPercent').value)||0;
      // };

      /* PRODUCT TYPES */
      $('productTypeForm').addEventListener('submit',async e=>{
        e.preventDefault();
        const n=$('productTypeName').value.trim();
        if(!n)return;
        
        const result = await apiCall('/api/product-types', {
          method: 'POST',
          body: JSON.stringify({ name: n })
        });
        
        if (result && !result.error) {
          $('productTypeName').value='';
          await loadData();
        } else {
          alert(result?.error || 'Failed to add product type');
        }
      });

      const renderTypeList=()=>$('productTypeList').innerHTML=types.map((t,i)=>`
        <li class="flex justify-between px-3 py-2 fade-in" style="animation-delay:${i*30}ms">
          <span>${t.type_name}</span><button data-id="${t.type_id}" class="text-red-400 hover:text-red-300"><svg data-lucide="trash-2" class="w-4 h-4"></svg></button>
        </li>`).join('');
      
      $('productTypeList').addEventListener('click',async e=>{
        const btn=e.target.closest('button');
        if(!btn)return;
        
        const result = await apiCall(`/api/product-types/${btn.dataset.id}`, {
          method: 'DELETE'
        });
        
        if (result && !result.error) {
          await loadData();
        } else {
          alert(result?.error || 'Failed to delete product type');
        }
      });

      const renderTypeOptions=()=>$('productTypeSelect').innerHTML='<option hidden>Select type</option>'+types.map(t=>option(t.type_id,t.type_name)).join('');

      /* PRODUCTS */
      $('productForm').addEventListener('submit', function(e) {
        e.preventDefault();
          const data = {
              name: document.getElementById('productName').value,
              rate: document.getElementById('productPrice').value,
              type_id: document.getElementById('productTypeSelect').value
          };
          if (editingProductId) {
              fetch(`/api/products/${editingProductId}`, {
                  method: 'PUT',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(data)
              }).then(res => res.json()).then(() => {
                  editingProductId = null;
                  this.reset();
                  if (typeof loadData === 'function') loadData();
              });
        } else {
              fetch('/api/products', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(data)
              }).then(res => res.json()).then(() => {
                  this.reset();
                  if (typeof loadData === 'function') loadData();
              });
        }
      });

      const renderProdTable = () => {
        $('productTable').querySelector('tbody').innerHTML = prods.map((p, i) => `
        <tr class="fade-in" style="animation-delay:${i*30}ms">
          <td class="px-3 py-2">${p.type_name}</td>
          <td class="px-3 py-2">${p.product_name}</td>
          <td class="px-3 py-2">AED ${parseFloat(p.rate).toFixed(2)}</td>
            <td class="px-3 py-2 flex gap-2">
              <button class="edit-product-btn text-blue-400 hover:text-blue-300" data-id="${p.product_id}">Edit</button>
              <button class="delete-product-btn text-red-400 hover:text-red-300" data-id="${p.product_id}">Delete</button>
            </td>
          </tr>
        `).join('');

        // Attach event listener every time after rendering
        $('productTable').querySelector('tbody').addEventListener('click', async (e) => {
          const editBtn = e.target.closest('.edit-product-btn');
          const deleteBtn = e.target.closest('.delete-product-btn');
          if (editBtn) {
            const productId = editBtn.dataset.id;
            const product = prods.find(p => p.product_id == productId);
            if (product) {
              $('productTypeSelect').value = product.type_id;
              $('productName').value = product.product_name;
              $('productPrice').value = product.rate;
              editingProductId = productId;
              $('productFormCancel').classList.add('hidden');
              $('productFormSubmit').textContent = 'Update';
            }
          }
          if (deleteBtn) {
            const productId = deleteBtn.dataset.id;
            if (await showConfirmDialog('Are you sure you want to delete this product?')) {
              const result = await apiCall(`/api/products/${productId}`, { method: 'DELETE' });
        if (result && !result.error) {
          await loadData();
        } else {
                alert(result?.error || 'Failed to delete product');
              }
            }
          }
        });
      };
      
      const renderProdOptions=()=>$('billProduct').innerHTML='<option hidden>Select product</option>'+prods.map((p,i)=>option(p.product_id,p.product_name)).join('');

      /* CUSTOMERS */
      // Update customer list to include Actions
      const renderCustomerList = () => {
        $('customerList').innerHTML = customers.map((c, i) => `
          <li class="flex justify-between px-3 py-2 fade-in items-center" style="animation-delay:${i*30}ms">
          <div>
            <span class="font-medium">${c.name}</span>
            ${c.phone ? `<span class="text-neutral-400 ml-2">${c.phone}</span>` : ''}
            ${c.city ? `<span class="text-neutral-400 ml-2">${c.city}</span>` : ''}
          </div>
            <div class="flex gap-2">
              <button class="edit-customer-btn text-blue-400 hover:text-blue-300" data-id="${c.customer_id}">Edit</button>
              <button class="delete-customer-btn text-red-400 hover:text-red-300" data-id="${c.customer_id}">Delete</button>
            </div>
          </li>
        `).join('');
      };

      // Add Cancel button to customer form
      if (!document.getElementById('customerFormCancel')) {
        const cancelBtn = document.createElement('button');
        cancelBtn.type = 'button';
        cancelBtn.id = 'customerFormCancel';
        cancelBtn.textContent = 'Cancel';
        cancelBtn.className = 'col-span-2 bg-neutral-700 hover:bg-neutral-600 text-white rounded-lg text-sm font-medium py-2 self-end hidden';
        $('customerForm').appendChild(cancelBtn);
        cancelBtn.addEventListener('click', () => {
          $('customerForm').reset();
          delete $('customerForm').dataset.editingId;
          cancelBtn.classList.add('hidden');
          $('customerFormSubmit').textContent = 'Add';
        });
      }
      // Ensure the Add button has an id for toggling (customer form)
      const customerSubmitBtn = $('customerForm').querySelector('button[type="submit"]');
      if (customerSubmitBtn) customerSubmitBtn.id = 'customerFormSubmit';

      // Update customer form submit handler to handle add and edit
      $('customerForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const data = {
            name: document.getElementById('customerName').value,
            phone: document.getElementById('customerPhone').value,
            city: document.getElementById('customerCity').value,
            area: document.getElementById('customerArea').value
        };
        let response;
        if (editingCustomerId) {
            response = await fetch(`/api/customers/${editingCustomerId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
        } else {
            response = await fetch('/api/customers', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
        }
        const result = await response.json();
        if (result && result.error) {
            showToast(result.error, 'error');
            return;
        }
        editingCustomerId = null;
        this.reset();
        if (typeof loadData === 'function') loadData();
      });

      /* VAT MASTER */
      $('vatForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const rate = parseFloat($('vatRate').value);
        const effFrom = $('vatEffDate').value;
        const toDate = '2099-12-31';
        if (!rate || rate < 0) return showToast('Invalid VAT %', 'error');
        if (!effFrom || new Date(effFrom) < new Date(new Date().toISOString().split('T')[0])) {
            showToast('Effective From date cannot be in the past', 'error');
            return;
        }
        // Find the last VAT row and update its To Date to the day before new Effective From
        const vatRows = document.querySelectorAll('#vatTable tbody tr');
        if (vatRows.length > 0) {
            const lastRow = vatRows[vatRows.length - 1];
            const lastFrom = lastRow.children[1].textContent.trim();
            const lastTo = lastRow.children[2].textContent.trim();
            // Only update if last To is 2099-12-31
            if (lastTo === '2099-12-31') {
                const prevToDate = new Date(effFrom);
                prevToDate.setDate(prevToDate.getDate() - 1);
                const prevToStr = prevToDate.toISOString().split('T')[0];
                // Optionally, update in UI (for instant feedback)
                lastRow.children[2].textContent = prevToStr;
                // Optionally, send a backend request to update the previous row
                // (Backend patch will handle this for real persistence)
            }
        }
        // Always set To Date to 2099-12-31 for new row
        $('vatToDate').value = '2099-12-31';
        // Submit to backend
        const result = await fetch('/api/vat-rates', {
          method: 'POST',
            headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            rate_percentage: rate,
                effective_from: effFrom,
                effective_to: toDate
          })
        }).then(r => r.json());
        if (result && result.error) {
            showToast(result.error, 'error');
            return;
        }
        this.reset();
        $('vatEffDate').setAttribute('min', new Date().toISOString().split('T')[0]);
        $('vatToDate').value = '2099-12-31';
        if (typeof loadData === 'function') loadData();
      });

      const renderVatTable=()=>$('vatTable').querySelector('tbody').innerHTML=vats.map((v,i)=>`
        <tr class="fade-in" style="animation-delay:${i*30}ms">
          <td class="px-3 py-2">${parseFloat(v.rate_percentage).toFixed(2)}%</td>
          <td class="px-3 py-2">${v.effective_from}</td>
          <td class="px-3 py-2">${v.effective_to}</td>
        </tr>`).join('');

      /* BILL ENTRY */
      $('billProduct').addEventListener('change',e=>{
        const selectedProduct = prods.find(p => p.product_id == e.target.value);
        $('billRate').value=selectedProduct ? parseFloat(selectedProduct.rate).toFixed(2) : '';
      });

      $('billingForm').addEventListener('submit',e=>{
        e.preventDefault();
        if(e.submitter?.id!=='addItemBtn')return;
        const idx=$('billProduct').value;
        if(idx==='')return;
        
        const p=prods.find(prod => prod.product_id == idx);
        if (!p) return;
        
        const qty=parseInt($('billQty').value,10),rate=parseFloat($('billRate').value)||p.rate,
              disc=parseFloat($('billDiscount').value)||0,adv=parseFloat($('billAdvPaid').value)||0;
        if(qty<=0||rate<=0)return;
        
        bill.push({
          product_id: p.product_id,
          name:p.product_name,
          qty,
          rate,
          disc,
          adv,
          total:qty*rate-disc-adv
        });
        
        ['billProduct','billRate','billQty','billDiscount','billAdvPaid'].forEach(id=>$(id).value=id==='billQty'?1:'');
        renderBillTable();
        updateTotals();
      });

      const renderBillTable = () => {
        $('billTable').querySelector('tbody').innerHTML = bill.map((i, idx) => `
        <tr class="fade-in" style="animation-delay:${idx*30}ms">
          <td class="px-3 py-2">${i.name}</td>
          <td class="px-3 py-2">${i.qty}</td>
          <td class="px-3 py-2">AED ${i.rate.toFixed(2)}</td>
          <td class="px-3 py-2">AED ${i.disc.toFixed(2)}</td>
          <td class="px-3 py-2">AED ${i.adv.toFixed(2)}</td>
          <td class="px-3 py-2">AED ${i.total.toFixed(2)}</td>
            <td class="px-3 py-2 flex gap-2">
              <button class="edit-bill-item-btn text-blue-400 hover:text-blue-300" data-idx="${idx}">Edit</button>
              <button class="delete-bill-item-btn text-red-400 hover:text-red-300" data-idx="${idx}">Delete</button>
            </td>
          </tr>
        `).join('');

        // Attach event listeners for edit/delete
        $('billTable').querySelector('tbody').addEventListener('click', (e) => {
          const editBtn = e.target.closest('.edit-bill-item-btn');
          const deleteBtn = e.target.closest('.delete-bill-item-btn');
          if (editBtn) {
            const idx = parseInt(editBtn.dataset.idx);
            const item = bill[idx];
            if (item) {
              $('billProduct').value = item.product_id;
              $('billRate').value = item.rate;
              $('billQty').value = item.qty;
              $('billDiscount').value = item.disc;
              $('billAdvPaid').value = item.adv;
              // Remove the item from the bill for editing
              bill.splice(idx, 1);
              renderBillTable();
              updateTotals();
            }
          }
          if (deleteBtn) {
            const idx = parseInt(deleteBtn.dataset.idx);
            bill.splice(idx, 1);
            renderBillTable();
            updateTotals();
          }
        });
      };

      // Make Print Receipt button print the bill table
      $('printBtn').addEventListener('click', async () => {
        if (bill.length === 0) return;
        if (!$('billDate').value) {
          showToast('Please select a Bill Date.', 'error');
          return;
        }
        // --- ADD MASTER VALIDATION ---
        if (typeof window.getSelectedMasterId === 'function' && !window.getSelectedMasterId()) {
          showToast('Please select a Master from the dropdown.', 'error');
          $('masterName').focus();
          return;
        }
        // ... existing code ...
        // Ensure bill_date is in YYYY-MM-DD format
        const billDateValue = new Date($('billDate').value).toISOString().split('T')[0];
        // Debug log


        // 1. Check for duplicate invoice number
        const billNumber = $('billNumber').value.trim();
        if (billNumber) {
          const checkResp = await fetch(`/api/bills?bill_number=${encodeURIComponent(billNumber)}`);
          if (checkResp.ok) {
            const bills = await checkResp.json();
            if (Array.isArray(bills) && bills.length > 0) {
              showToast('This invoice number already exists. Please use a unique Bill #.', 'error');
              return;
            }
          }
        }

        // 2. Find customer_id from customers array
        let customerId = null;
        const customerName = $('billCustomer').value.trim();
        const customerPhone = $('billMobile').value.trim();
        if (window.customers && Array.isArray(window.customers)) {
          const match = window.customers.find(c =>
            c.name && c.name.trim().toLowerCase() === customerName.toLowerCase() &&
            (!customerPhone || (c.phone && c.phone.trim() === customerPhone))
          );
          if (match) customerId = match.customer_id;
      }

        // Calculate totals
        const subtotal = bill.reduce((sum, i) => sum + i.total, 0);
        const vatPercent = parseFloat($('vatPercent').value) || 0;
        const vatAmount = subtotal * vatPercent / 100;
        const advancePaid = bill.reduce((sum, i) => sum + (i.adv || 0), 0);
        const totalAmount = subtotal + vatAmount;
        const balanceAmount = totalAmount - advancePaid;

        // Gather bill meta info
        const billMeta = {
          bill_number: billNumber,
          customer_id: customerId,
          customer_name: customerName,
          customer_phone: customerPhone,
            customer_city: $('billCity').value,
            customer_area: $('billArea').value,
          bill_date: billDateValue,
            delivery_date: $('deliveryDate').value,
            payment_method: $('paymentMethod').value,
          vat_percent: vatPercent,
          subtotal: subtotal,
          vat_amount: vatAmount,
          total_amount: totalAmount,
          advance_paid: advancePaid,
          balance_amount: balanceAmount,
          master_id: window.getSelectedMasterId ? window.getSelectedMasterId() : null,
          trial_date: $('trialDate').value
        };
        const items = bill.map(i => ({
          product_id: i.product_id,
          product_name: i.name,
          quantity: i.qty,
          rate: i.rate,
          discount: i.disc,
          advance_paid: i.adv,
          total_amount: i.total
        }));
        const payload = {
          bill: billMeta,
          items: items
        };
        // Save bill to backend
        const result = await fetch('/api/bills', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        }).then(r => r.json());
        if (result && (result.bill_id || result.id)) {
          // Open print page in new tab
          const billId = result.bill_id || result.id;
          window.open(`/api/bills/${billId}/print`, '_blank');
          // Optionally, clear bill and disable print button
          bill.length = 0;
          renderBillTable();
          updateTotals();
          // Auto-generate next Bill # and reset user-edited flag
          const resp = await fetch('/api/next-bill-number');
          if (resp.ok) {
            const data = await resp.json();
            if (data && data.bill_number) {
              $('billNumber').value = data.bill_number;
              delete $('billNumber').dataset.userEdited;
            }
          }
        } else {
          showToast(result?.error || 'Failed to save and print bill', 'error');
        }
      });

      // Call this after your dashboard loads:
      loadData();

      // Dashboard refresh button
      $('refreshDashboardBtn').addEventListener('click', () => {
        loadDashboardData();
      });

      // Attach customer edit/delete event listener ONCE, with robust checks
      $('customerList').addEventListener('click', async (e) => {
        // Defensive: check if customers array exists and is an array
        if (!Array.isArray(customers)) {
          console.error('customers array is not defined or not an array:', customers);
          return;
        }
        const editBtn = e.target.closest('.edit-customer-btn');
        const deleteBtn = e.target.closest('.delete-customer-btn');
        if (editBtn) {
          const customerId = editBtn.dataset.id;
          const customer = customers.find(c => c.customer_id == customerId);
          if (customer) {
            $('customerName').value = customer.name || '';
            $('customerPhone').value = customer.phone || '';
            $('customerCity').value = customer.city || '';
            $('customerArea').value = customer.area || '';
            editingCustomerId = customerId;
            $('customerFormCancel').classList.add('hidden');
            $('customerFormSubmit').textContent = 'Update';
          }
        }
        if (deleteBtn) {
          const customerId = deleteBtn.dataset.id;
          if (await showConfirmDialog('Are you sure you want to delete this customer?')) {
            const result = await apiCall(`/api/customers/${customerId}`, { method: 'DELETE' });
        if (result && !result.error) {
              await loadData();
        } else {
              alert(result?.error || 'Failed to delete customer');
            }
          }
        }
      });

      // Search & Reprint Invoice modal logic
      $('searchInvoiceBtn').addEventListener('click', () => {
        $('searchInvoiceModal').classList.remove('hidden');
        $('searchInvoiceInput').value = '';
        $('searchInvoiceResults').innerHTML = '';
        $('searchInvoiceInput').focus(); // Set focus to the input box
      });
      $('closeSearchInvoice').addEventListener('click', () => {
        $('searchInvoiceModal').classList.add('hidden');
      });
      // Search invoices as you type
      $('searchInvoiceInput').addEventListener('input', async (e) => {
        const q = e.target.value.trim().toLowerCase();
        if (!q) {
          $('searchInvoiceResults').innerHTML = '';
          return;
        }
        const allBills = await apiCall('/api/bills');
        const results = (allBills || []).filter(bill =>
          (bill.bill_number && bill.bill_number.toLowerCase().includes(q)) ||
          (bill.customer_name && bill.customer_name.toLowerCase().includes(q)) ||
          (bill.customer_phone && bill.customer_phone.toLowerCase().includes(q))
        );
        $('searchInvoiceResults').innerHTML = results.length
          ? `<table class="min-w-full text-sm">
              <thead><tr>
                <th class="px-2 py-1 text-left">Invoice #</th>
                <th class="px-2 py-1 text-left">Customer</th>
                <th class="px-2 py-1 text-left">Date</th>
                <th class="px-2 py-1 text-left">Amount</th>
                <th class="px-2 py-1 text-left">Status</th>
                <th></th>
              </tr></thead>
              <tbody>
                ${results.map(bill => `
                  <tr>
                    <td class="px-2 py-1">${bill.bill_number || bill.bill_id}</td>
                    <td class="px-2 py-1">${bill.customer_name || ''}</td>
                    <td class="px-2 py-1">${bill.bill_date || ''}</td>
                    <td class="px-2 py-1">AED ${parseFloat(bill.total_amount).toFixed(2)}</td>
                    <td class="px-2 py-1">${bill.status || (bill.balance_amount > 0 ? 'Pending' : 'Paid')}</td>
                    <td class="px-2 py-1 flex gap-2">
                      <button class="reprint-btn bg-indigo-600 hover:bg-indigo-500 text-white rounded px-3 py-1" data-id="${bill.bill_id}">Reprint</button>
                      ${(bill.status === 'Pending' || (bill.balance_amount && bill.balance_amount > 0)) ? `<button class="mark-paid-btn bg-green-600 hover:bg-green-500 text-white rounded px-3 py-1" data-id="${bill.bill_id}" data-balance="${bill.balance_amount}">Mark as Paid</button>` : ''}
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>`
          : '<div class="text-neutral-400 text-center py-4">No invoices found.</div>';
      });

      // Auto-fill customer name by mobile number in billing form
      $('billMobile').addEventListener('blur', async (e) => {
        const phone = e.target.value.trim();
        if (!phone) return;
        // Check if customer exists
        const resp = await fetch(`/api/customers?phone=${encodeURIComponent(phone)}`);
        if (resp.ok) {
          const customers = await resp.json();
          if (Array.isArray(customers) && customers.length > 0) {
            // Customer exists, fill name, city, area
            $('billCustomer').value = customers[0].name || '';
            $('billCity').value = customers[0].city || '';
            $('billArea').value = customers[0].area || '';
          } else {
            // Customer does not exist, clear fields for manual entry
          $('billCustomer').value = '';
          $('billCity').value = '';
          $('billArea').value = '';
          }
        }
      });

      // Area autocomplete for billing form
      (function() {
        let cachedAreas = null;
        let areaDropdown = null;

        function createDropdown() {
          if (areaDropdown) areaDropdown.remove();
          areaDropdown = document.createElement('div');
          areaDropdown.style.position = 'absolute';
          areaDropdown.style.background = '#222';
          areaDropdown.style.border = '1px solid #444';
          areaDropdown.style.zIndex = 1000;
          areaDropdown.style.width = $('billArea').offsetWidth + 'px';
          areaDropdown.className = 'rounded shadow-lg text-sm';
          areaDropdown.style.maxHeight = '180px';
          areaDropdown.style.overflowY = 'auto';
          areaDropdown.style.color = '#fff';
          document.body.appendChild(areaDropdown);
        }

        function showDropdown(matches, input) {
          createDropdown();
          const rect = input.getBoundingClientRect();
          areaDropdown.style.left = rect.left + window.scrollX + 'px';
          areaDropdown.style.top = rect.bottom + window.scrollY + 'px';
          areaDropdown.innerHTML = '';
          matches.forEach(area => {
            const item = document.createElement('div');
            item.textContent = area;
            item.className = 'px-3 py-2 cursor-pointer hover:bg-indigo-600';
            item.addEventListener('mousedown', e => {
              e.preventDefault();
              input.value = area;
              areaDropdown.style.display = 'none';
            });
            areaDropdown.appendChild(item);
          });
          areaDropdown.style.display = matches.length ? 'block' : 'none';
        }

        function hideDropdown() {
          if (areaDropdown) areaDropdown.style.display = 'none';
        }

        $('billArea').addEventListener('focus', async function(e) {
          if (!cachedAreas) {
            const resp = await fetch('/api/areas');
            if (resp.ok) {
              cachedAreas = await resp.json();
        } else {
              cachedAreas = [];
            }
        }
      });

        $('billArea').addEventListener('input', function(e) {
          const val = e.target.value.trim().toLowerCase();
          if (!cachedAreas || val.length < 3) {
            hideDropdown();
            return;
          }
          const matches = cachedAreas.filter(area => area.toLowerCase().includes(val));
          if (matches.length) {
            showDropdown(matches, e.target);
          } else {
            hideDropdown();
          }
        });

        $('billArea').addEventListener('blur', function() {
          setTimeout(hideDropdown, 150);
        });
      })();
          
      // City autocomplete for billing form
      (function() {
        let cachedCities = null;
        let cityDropdown = null;

        function createDropdown() {
          if (cityDropdown) cityDropdown.remove();
          cityDropdown = document.createElement('div');
          cityDropdown.style.position = 'absolute';
          cityDropdown.style.background = '#222';
          cityDropdown.style.border = '1px solid #444';
          cityDropdown.style.zIndex = 1000;
          cityDropdown.style.width = $('billCity').offsetWidth + 'px';
          cityDropdown.className = 'rounded shadow-lg text-sm';
          cityDropdown.style.maxHeight = '180px';
          cityDropdown.style.overflowY = 'auto';
          cityDropdown.style.color = '#fff';
          document.body.appendChild(cityDropdown);
        }
        
        function showDropdown(matches, input) {
          createDropdown();
          const rect = input.getBoundingClientRect();
          cityDropdown.style.left = rect.left + window.scrollX + 'px';
          cityDropdown.style.top = rect.bottom + window.scrollY + 'px';
          cityDropdown.innerHTML = '';
          matches.forEach(city => {
            const item = document.createElement('div');
            item.textContent = city;
            item.className = 'px-3 py-2 cursor-pointer hover:bg-indigo-600';
            item.addEventListener('mousedown', e => {
              e.preventDefault();
              input.value = city;
              cityDropdown.style.display = 'none';
            });
            cityDropdown.appendChild(item);
          });
          cityDropdown.style.display = matches.length ? 'block' : 'none';
        }

        function hideDropdown() {
          if (cityDropdown) cityDropdown.style.display = 'none';
        }

        $('billCity').addEventListener('focus', async function(e) {
          if (!cachedCities) {
            const resp = await fetch('/api/cities');
            if (resp.ok) {
              cachedCities = await resp.json();
            } else {
              cachedCities = [];
            }
          }
        });

        $('billCity').addEventListener('input', function(e) {
          const val = e.target.value.trim().toLowerCase();
          if (!cachedCities || val.length < 2) {
            hideDropdown();
            return;
          }
          const matches = cachedCities.filter(city => city.toLowerCase().includes(val));
          if (matches.length) {
            showDropdown(matches, e.target);
          } else {
            hideDropdown();
          }
        });

        $('billCity').addEventListener('blur', function() {
          setTimeout(hideDropdown, 150);
        });
      })();

      /* EMPLOYEES CRUD */
      $('employeeForm').addEventListener('submit', async e => {
        e.preventDefault();
        const name = $('employeeName').value.trim();
        const mobile = $('employeeMobile').value.trim();
        const address = $('employeeAddress').value.trim();
        if (!name) return;
        const editingId = $('employeeForm').dataset.editingId;
        if (editingId) {
          // Edit mode
          const result = await apiCall(`/api/employees/${editingId}`, {
            method: 'PUT',
            body: JSON.stringify({ name, mobile, address })
          });
          if (result && !result.error) {
            $('employeeForm').reset();
            delete $('employeeForm').dataset.editingId;
            $('employeeFormSubmit')?.classList.add('hidden');
            await loadData();
          } else {
            alert(result?.error || 'Failed to update employee');
          }
        } else {
          // Add mode
          const result = await apiCall('/api/employees', {
            method: 'POST',
            body: JSON.stringify({ name, mobile, address })
          });
          if (result && !result.error) {
            $('employeeName').value = '';
            $('employeeMobile').value = '';
            $('employeeAddress').value = '';
            await loadData();
          } else {
            alert(result?.error || 'Failed to add employee');
          }
        }
      });
      const renderEmployeeList = () => {
        $('employeeList').innerHTML = employees.map((e, i) => `
          <li class="flex justify-between px-3 py-2 fade-in" style="animation-delay:${i*30}ms">
            <span>${e.name} <span class="text-neutral-400">(${e.mobile || ''})</span> <span class="text-neutral-500">${e.address || ''}</span></span>
            <span class="flex gap-2">
              <button class="edit-employee-btn text-blue-400 hover:text-blue-300" data-id="${e.employee_id}">Edit</button>
              <button class="delete-employee-btn text-red-400 hover:text-red-300" data-id="${e.employee_id}">Delete</button>
            </span>
          </li>
        `).join('');
      };
      $('employeeList').addEventListener('click', async e => {
        const editBtn = e.target.closest('.edit-employee-btn');
        const deleteBtn = e.target.closest('.delete-employee-btn');
        if (editBtn) {
          const empId = editBtn.dataset.id;
          const emp = employees.find(emp => emp.employee_id == empId);
          if (emp) {
            $('employeeName').value = emp.name || '';
            $('employeeMobile').value = emp.mobile || '';
            $('employeeAddress').value = emp.address || '';
            $('employeeForm').dataset.editingId = empId;
            $('employeeFormSubmit')?.classList.remove('hidden');
          }
        }
        if (deleteBtn) {
          const empId = deleteBtn.dataset.id;
          if (await showConfirmDialog('Are you sure you want to delete this employee?')) {
            const result = await apiCall(`/api/employees/${empId}`, { method: 'DELETE' });
            if (result && !result.error) {
              await loadData();
            } else {
              alert(result?.error || 'Failed to delete employee');
            }
          }
        }
      });

      // Master autocomplete for billing form
      (function() {
        let cachedMasters = null;
        let masterDropdown = null;
        let selectedMasterId = null;
        function createDropdown() {
          if (masterDropdown) masterDropdown.remove();
          masterDropdown = document.createElement('div');
          masterDropdown.style.position = 'absolute';
          masterDropdown.style.background = '#222';
          masterDropdown.style.border = '1px solid #444';
          masterDropdown.style.zIndex = 1000;
          masterDropdown.style.width = $('masterName').offsetWidth + 'px';
          masterDropdown.className = 'rounded shadow-lg text-sm';
          masterDropdown.style.maxHeight = '180px';
          masterDropdown.style.overflowY = 'auto';
          masterDropdown.style.color = '#fff';
          document.body.appendChild(masterDropdown);
        }
        function showDropdown(matches, input) {
          createDropdown();
          const rect = input.getBoundingClientRect();
          masterDropdown.style.left = rect.left + window.scrollX + 'px';
          masterDropdown.style.top = rect.bottom + window.scrollY + 'px';
          masterDropdown.innerHTML = '';
          matches.forEach(emp => {
            const item = document.createElement('div');
            item.textContent = emp.name;
            item.className = 'px-3 py-2 cursor-pointer hover:bg-indigo-600';
            item.addEventListener('mousedown', e => {
              e.preventDefault();
              input.value = emp.name;
              selectedMasterId = emp.employee_id;
              masterDropdown.style.display = 'none';
            });
            masterDropdown.appendChild(item);
          });
          masterDropdown.style.display = matches.length ? 'block' : 'none';
        }
        function hideDropdown() {
          if (masterDropdown) masterDropdown.style.display = 'none';
        }
        $('masterName').addEventListener('focus', async function(e) {
          if (!cachedMasters) {
            const resp = await fetch('/api/employees');
            if (resp.ok) {
              cachedMasters = await resp.json();
            } else {
              cachedMasters = [];
            }
          }
        });
        $('masterName').addEventListener('input', function(e) {
          const val = e.target.value.trim().toLowerCase();
          if (!cachedMasters || val.length < 2) {
            hideDropdown();
            return;
          }
          const matches = cachedMasters.filter(emp => emp.name.toLowerCase().includes(val));
          if (matches.length) {
            showDropdown(matches, e.target);
          } else {
            hideDropdown();
          }
        });
        $('masterName').addEventListener('blur', function() {
          setTimeout(hideDropdown, 150);
        });
        // Expose selectedMasterId globally for bill POST
        window.getSelectedMasterId = () => selectedMasterId;
        // Reset selectedMasterId if masterName input is cleared
        $('masterName').addEventListener('change', function(e) {
          if (!e.target.value.trim()) selectedMasterId = null;
        });
      })();

      // SETTINGS: Backup & Restore
      async function loadBackupTable() {
        const resp = await fetch('/api/backups');
        const backups = await resp.json();
        const tbody = $('backupTableBody');
        if (!Array.isArray(backups)) {
          showToast(backups.error || 'Failed to load backups', 'error');
          tbody.innerHTML = '';
          return;
        }
        tbody.innerHTML = backups.map(b => `
          <tr>
            <td class="px-3 py-2">${b.date}</td>
            <td class="px-3 py-2">${b.name}</td>
            <td class="px-3 py-2 flex gap-2">
              <button class="download-backup-btn bg-blue-600 hover:bg-blue-500 text-white rounded px-3 py-1" data-fn="${b.name}">Download</button>
              <button class="restore-backup-btn bg-green-600 hover:bg-green-500 text-white rounded px-3 py-1" data-fn="${b.name}">Restore</button>
            </td>
          </tr>
        `).join('');
      }
      // Load backups when Settings page is shown
      document.querySelector('.nav-btn[data-go="settingsSec"]').addEventListener('click', loadBackupTable);
      // Backup Now button
      $('backupBtn').addEventListener('click', async () => {
        const resp = await fetch('/api/backup/upload', { method: 'POST' });
        const data = await resp.json();
        showToast(data.message || 'Backup complete', 'success');
        await loadBackupTable();
      });
      // Restore from file
      $('restoreInput').addEventListener('change', async (e) => {
        if (!e.target.files.length) return;
        if (!(await showConfirmDialog('Are you sure you want to restore this backup? This will overwrite all current data.'))) return;
        const formData = new FormData();
        formData.append('file', e.target.files[0]);
        const resp = await fetch('/api/restore', { method: 'POST', body: formData });
        const data = await resp.json();
        showToast(data.message || 'Restore complete', 'success');
        e.target.value = '';
      });
              // Download/Restore backup table
      $('backupTableBody').addEventListener('click', async (e) => {
        const dlBtn = e.target.closest('.download-backup-btn');
        const rsBtn = e.target.closest('.restore-backup-btn');
        if (dlBtn) {
          window.open(`/api/backup/download/${encodeURIComponent(dlBtn.dataset.fn)}`, '_blank');
        }
        if (rsBtn) {
          if (!(await showConfirmDialog('Restore this backup? This will overwrite all current data.'))) return;
          const resp = await fetch(`/api/backup/restore/${encodeURIComponent(rsBtn.dataset.fn)}`, { method: 'POST' });
          const data = await resp.json();
          showToast(data.message || 'Restore complete', 'success');
        }
      });

      // Find the Add button for billing items (assume id='addBillItemBtn' or similar)
      // Add validation before adding an item:
      const addBillItemBtn = document.getElementById('addBillItemBtn');
      if (addBillItemBtn) {
          addBillItemBtn.addEventListener('click', function(e) {
              // Require master selected from dropdown
              if (typeof window.getSelectedMasterId === 'function' && !window.getSelectedMasterId()) {
                  showToast('Please select a Master from the dropdown.', 'error');
                  document.getElementById('masterName').focus();
                  e.preventDefault();
                  return false;
              }
              const masterName = document.getElementById('masterName').value.trim();
              if (!masterName) {
                  showToast('Master Name is required.', 'error');
                  document.getElementById('masterName').focus();
                  e.preventDefault();
                  return false;
              }
              // ... existing add item logic ...
          }, true);
      }

      // ... existing code ...
      $('searchInvoiceResults').addEventListener('click', async (e) => {
        const btn = e.target.closest('.reprint-btn');
        if (btn) {
          const billId = btn.dataset.id;
          window.open(`/api/bills/${billId}/print`, '_blank');
          return;
        }
        const payBtn = e.target.closest('.mark-paid-btn');
        if (payBtn) {
          const billId = payBtn.dataset.id;
          let balance = parseFloat(payBtn.dataset.balance);
          if (!balance || balance <= 0) {
            showToast('No balance due.', 'info');
            return;
          }
          // Find bill details from the last search results
          const row = payBtn.closest('tr');
          const billNum = row.children[0].textContent;
          const customer = row.children[1].textContent;
          const date = row.children[2].textContent;
          const total = parseFloat(row.children[3].textContent.replace('AED',''));
          const status = row.children[4].textContent;
          // Fetch delivery date from backend (optional, fallback to '-')
          let delivery = '-';
          try {
            const resp = await fetch(`/api/bills/${billId}`);
            const data = await resp.json();
            if (data && data.bill && data.bill.delivery_date) delivery = data.bill.delivery_date;
          } catch {}
          const paid = total - balance;
          showPaymentModal({
            billNum,
            customer,
            paid,
            due: balance,
            max: balance,
            total,
            delivery,
            status,
            onOk: async (amount) => {
              payBtn.disabled = true;
              payBtn.textContent = 'Processing...';
              const resp = await fetch(`/api/bills/${billId}/payment`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ amount_paid: amount })
              });
              const result = await resp.json();
              if (result && result.bill && !result.error) {
                showPaymentProgressModal(() => {
                  showToast('Payment recorded. Bill is now ' + (result.bill.status || 'updated'), 'success');
                  $('searchInvoiceInput').dispatchEvent(new Event('input'));
                });
              } else {
                showToast(result?.error || 'Failed to update payment', 'error');
                payBtn.disabled = false;
                payBtn.textContent = 'Mark as Paid';
              }
            }
          });
        }
      });
      // ... existing code ...
    });

    // Toast notification system
    function showToast(msg, type = 'info', duration = 3000) {
      let toast = document.createElement('div');
      toast.textContent = msg;
      toast.className = `fixed z-50 left-1/2 -translate-x-1/2 top-8 px-6 py-3 rounded-lg shadow-lg text-sm font-medium transition-all toast-${type}`;
      toast.style.background = type === 'error' ? '#ef4444' : (type === 'success' ? '#22c55e' : '#334155');
      toast.style.color = '#fff';
      toast.style.opacity = '0.95';
      document.body.appendChild(toast);
      setTimeout(() => { toast.style.opacity = '0'; }, duration - 400);
      setTimeout(() => { toast.remove(); }, duration);
    }

    function debounce(func, wait) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
        };
    }
    // --- Customer Search ---
    const customerSearch = document.getElementById('customerSearch');
    const customerResults = document.getElementById('customerResults');
    if (customerSearch) {
        customerSearch.addEventListener('input', debounce(function() {
            const query = this.value.trim();
            if (!query) {
                customerResults.innerHTML = '';
                return;
            }
            fetch('/api/customers?search=' + encodeURIComponent(query))
                .then(res => res.json())
                .then(data => {
                    customerResults.innerHTML = data.length
                        ? '<ul>' + data.map(c => `<li>${c.name} (${c.phone}) <button type="button" class="edit-customer-btn" data-customer='${JSON.stringify(c)}' style='color:#2563eb;text-decoration:underline;background:none;border:none;cursor:pointer;padding:0 4px;'>Edit</button></li>`).join('') + '</ul>'
                        : '<em>No customers found.</em>';
                });
        }, 300));
    }
    // --- Product Search ---
    const productSearch = document.getElementById('productSearch');
    const productResults = document.getElementById('productResults');
    if (productSearch) {
        productSearch.addEventListener('input', debounce(function() {
            const query = this.value.trim();
            if (!query) {
                productResults.innerHTML = '';
                return;
            }
            fetch('/api/products?search=' + encodeURIComponent(query))
                .then(res => res.json())
                .then(data => {
                    productResults.innerHTML = data.length
                        ? '<ul>' + data.map(p => `<li>${p.product_name} (${p.type_name}) <button type="button" class="edit-product-btn" data-product='${JSON.stringify(p)}' style='color:#2563eb;text-decoration:underline;background:none;border:none;cursor:pointer;padding:0 4px;'>Edit</button></li>`).join('') + '</ul>'
                        : '<em>No products found.</em>';
                });
        }, 300));
    }
    // Add event listener for edit buttons
    document.addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('edit-customer-btn')) {
            const customer = JSON.parse(e.target.getAttribute('data-customer'));
            document.getElementById('customerName').value = customer.name || '';
            document.getElementById('customerPhone').value = customer.phone || '';
            document.getElementById('customerCity').value = customer.city || '';
            document.getElementById('customerArea').value = customer.area || '';
            editingCustomerId = customer.customer_id || null;
            document.getElementById('customerName').focus();
            // Hide search results after clicking Edit
            const customerResults = document.getElementById('customerResults');
            if (customerResults) customerResults.innerHTML = '';
            // Clear the search box
            const customerSearch = document.getElementById('customerSearch');
            if (customerSearch) customerSearch.value = '';
        }
    });
    // Add event listener for edit buttons
    document.addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('edit-product-btn')) {
            const product = JSON.parse(e.target.getAttribute('data-product'));
            document.getElementById('productName').value = product.product_name || '';
            document.getElementById('productPrice').value = product.rate || '';
            const typeSelect = document.getElementById('productTypeSelect');
            if (typeSelect && product.type_id) {
                typeSelect.value = product.type_id;
            }
            editingProductId = product.product_id || product.id || null;
            document.getElementById('productName').focus();
        }
      });

    // Modern confirmation dialog
    function showConfirmDialog(message) {
      return new Promise(resolve => {
        const modal = document.getElementById('confirmModal');
        const msg = document.getElementById('confirmModalMsg');
        const okBtn = document.getElementById('confirmModalOk');
        const cancelBtn = document.getElementById('confirmModalCancel');
        msg.textContent = message;
        modal.classList.remove('hidden');
        function cleanup(result) {
          modal.classList.add('hidden');
          okBtn.removeEventListener('click', onOk);
          cancelBtn.removeEventListener('click', onCancel);
          resolve(result);
        }
        function onOk() { cleanup(true); }
        function onCancel() { cleanup(false); }
        okBtn.addEventListener('click', onOk);
        cancelBtn.addEventListener('click', onCancel);
      });
    }
    // Replace all window.confirm() calls for delete actions:
    // Example for products:
    document.addEventListener('click', async function(e) {
      if (e.target && e.target.classList.contains('delete-product-btn')) {
        const confirmed = await showConfirmDialog('Are you sure you want to delete this product?');
        if (confirmed) {
          // ... existing delete logic ...
        }
      }
    });
    // Repeat similar replacement for customers, employees, etc.
    // ... existing code ...

    function showPaymentModal({billNum, customer, paid, due, max, total, delivery, status, onOk}) {
      const modal = document.getElementById('paymentModal');
      document.getElementById('payBillNum').textContent = billNum;
      document.getElementById('payCustomer').textContent = customer;
      document.getElementById('payPaid').textContent = `AED ${parseFloat(paid).toFixed(2)}`;
      document.getElementById('payDue').textContent = `AED ${parseFloat(due).toFixed(2)}`;
      document.getElementById('payTotal').textContent = `AED ${parseFloat(total).toFixed(2)}`;
      document.getElementById('payDelivery').textContent = delivery || '-';
      document.getElementById('payStatus').textContent = status || '-';
      const input = document.getElementById('payAmountInput');
      input.value = parseFloat(due).toFixed(2);
      input.max = max;
      input.focus();
      modal.classList.remove('hidden');
      function cleanup() {
        modal.classList.add('hidden');
        okBtn.removeEventListener('click', onOkClick);
        cancelBtn.removeEventListener('click', onCancelClick);
      }
      function onOkClick() {
        let val = parseFloat(input.value);
        if (isNaN(val) || val <= 0 || val > max) {
          showToast(`Enter a valid amount (max AED ${parseFloat(max).toFixed(2)})`, 'error');
          input.focus();
          return;
        }
        cleanup();
        onOk(val);
      }
      function onCancelClick() {
        cleanup();
      }
      const okBtn = document.getElementById('payModalOk');
      const cancelBtn = document.getElementById('payModalCancel');
      okBtn.addEventListener('click', onOkClick);
      cancelBtn.addEventListener('click', onCancelClick);
    }

    // ... existing code ...
    function showPaymentProgressModal(onDone) {
      const modal = document.getElementById('paymentProgressModal');
      const arc = document.getElementById('progressArc');
      const check = document.getElementById('progressCheck');
      const msg = document.getElementById('progressStepMsg');
      const okBtn = document.getElementById('progressOkBtn');
      modal.classList.remove('hidden');
      arc.style.strokeDashoffset = 226.194;
      check.style.opacity = 0;
      okBtn.classList.add('hidden');
      msg.textContent = 'Updating Total Amount Paid...';
      let step = 0;
      const steps = [
        { text: 'Updating Total Amount Paid...', percent: 0.33 },
        { text: 'Updating Payment...', percent: 0.66 },
        { text: 'Update Status.', percent: 1.0 }
      ];
      function animateStep() {
        if (step < steps.length) {
          msg.textContent = steps[step].text;
          arc.style.transition = 'stroke-dashoffset 0.7s linear';
          arc.style.strokeDashoffset = 226.194 * (1 - steps[step].percent);
          step++;
          setTimeout(animateStep, step < steps.length ? 800 : 700);
        } else {
          // Success
          arc.style.transition = 'stroke-dashoffset 0.3s linear';
          arc.style.strokeDashoffset = 0;
          setTimeout(() => {
            arc.style.opacity = 0;
            check.style.opacity = 1;
            msg.textContent = 'Payment Successful!';
            okBtn.classList.remove('hidden');
            okBtn.onclick = () => {
              modal.classList.add('hidden');
              arc.style.opacity = 1;
              if (onDone) onDone();
            };
          }, 400);
        }
      }
      animateStep();
    }
    // ... existing code ...
    // In the Mark as Paid handler, after successful payment API call, show the progress modal:
    // Replace:
    // showToast('Payment updated!', 'success');
    // With:
    // showPaymentProgressModal(() => showToast('Payment updated!', 'success'));
    // ... existing code ...
  </script>

  <!-- Confirmation Modal -->
  <div id="confirmModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 hidden">
    <div class="bg-neutral-900 rounded-lg shadow-lg p-6 w-full max-w-xs text-center">
      <div id="confirmModalMsg" class="mb-6 text-white text-base font-medium"></div>
      <div class="flex justify-center gap-4">
        <button id="confirmModalOk" class="bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg px-6 py-2 font-semibold">OK</button>
        <button id="confirmModalCancel" class="bg-neutral-700 hover:bg-neutral-600 text-white rounded-lg px-6 py-2 font-semibold">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Payment Modal -->
  <div id="paymentModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 hidden">
    <div class="bg-neutral-900 rounded-lg shadow-lg p-6 w-full max-w-xs text-center">
      <div class="mb-4">
        <div class="text-white text-base font-semibold mb-2">Receive Payment</div>
        <div class="text-sm text-neutral-300 mb-1"><span id="payBillNum"></span> &mdash; <span id="payCustomer"></span></div>
        <div class="text-sm text-neutral-400 mb-1">Total Bill: <span id="payTotal"></span></div>
        <div class="text-sm text-neutral-400 mb-1">Amount Paid: <span id="payPaid"></span></div>
        <div class="text-sm text-neutral-400 mb-1">Amount Due: <span id="payDue"></span></div>
        <div class="text-sm text-neutral-400 mb-1">Delivery Date: <span id="payDelivery"></span></div>
        <div class="text-sm text-neutral-400 mb-2">Status: <span id="payStatus"></span></div>
        <input id="payAmountInput" type="number" min="0.01" step="0.01" class="w-full px-3 py-2 rounded bg-neutral-800 border border-neutral-700 text-white mb-2" placeholder="Enter amount received">
      </div>
      <div class="flex justify-center gap-4">
        <button id="payModalOk" class="bg-green-600 hover:bg-green-500 text-white rounded-lg px-6 py-2 font-semibold">OK</button>
        <button id="payModalCancel" class="bg-neutral-700 hover:bg-neutral-600 text-white rounded-lg px-6 py-2 font-semibold">Cancel</button>
      </div>
    </div>
  </div>
  <!-- Payment Progress Modal -->
  <div id="paymentProgressModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 hidden">
    <div class="bg-neutral-900 rounded-lg shadow-lg p-8 w-full max-w-xs flex flex-col items-center">
      <div class="relative mb-4">
        <svg id="progressCircle" width="80" height="80" viewBox="0 0 80 80">
          <circle cx="40" cy="40" r="36" stroke="#444" stroke-width="6" fill="none" />
          <circle id="progressArc" cx="40" cy="40" r="36" stroke="#22d3ee" stroke-width="6" fill="none" stroke-linecap="round" stroke-dasharray="226.194" stroke-dashoffset="226.194"/>
          <g id="progressCheck" style="opacity:0">
            <circle cx="40" cy="40" r="36" stroke="#22d3ee" stroke-width="6" fill="#22d3ee"/>
            <polyline points="28,42 38,52 54,32" fill="none" stroke="#fff" stroke-width="5" stroke-linecap="round" stroke-linejoin="round"/>
          </g>
        </svg>
      </div>
      <div id="progressStepMsg" class="text-white text-base font-semibold mb-2">Processing...</div>
      <button id="progressOkBtn" class="mt-4 px-4 py-2 rounded bg-cyan-500 text-white font-semibold hidden">OK</button>
    </div>
  </div>
</body>
</html> 