{% extends "base.html" %}

{% block title %}Pricing - Tajir{% endblock %}

{% block extra_head %}
<style>
  .pricing-card {
    @apply bg-neutral-800/60 px-8 py-6 rounded-2xl border border-neutral-700 transition-all duration-300;
    height: 600px;
    display: flex;
    flex-direction: column;
    position: relative;
    z-index: 1;
    box-shadow: 0 2px 16px 0 rgba(0,0,0,0.12);
    border-image: linear-gradient(90deg, #6366f1 0%, #06b6d4 100%) 1;
    border-width: 2px;
    border-style: solid;
    border-image-slice: 1;
    border-image-source: linear-gradient(90deg, #27272a 0%, #27272a 100%);
  }
  .pricing-card:hover {
    @apply shadow-2xl;
    transform: scale(1.045) translateY(-8px);
    border-image-source: linear-gradient(90deg, #6366f1 0%, #06b6d4 100%);
    box-shadow: 0 8px 32px 0 rgba(34,211,238,0.25), 0 2px 16px 0 rgba(99,102,241,0.18);
    transition: transform 0.25s cubic-bezier(.33,1,.68,1), box-shadow 0.25s, border-image-source 0.4s;
  }
  .pricing-card.popular {
    @apply border-indigo-500 shadow-lg shadow-indigo-500/20;
  }
  .feature-check {
    @apply text-green-400;
  }
  .feature-lock {
    @apply text-neutral-500;
  }
  .pricing-card .btn-container {
    margin-top: auto;
    padding-top: 1rem;
  }
  .popular-badge {
    @apply absolute -top-4 left-1/2 transform -translate-x-1/2 bg-indigo-600 text-white text-xs font-semibold px-3 py-1 rounded-full z-10;
  }
  .card-content {
    flex: 1;
    display: flex;
    flex-direction: column;
  }
  .features-section {
    flex: 1;
  }
  .features-section .flex {
    gap: 1rem;
    padding-left: 2rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto py-16 px-4 sm:px-6 lg:px-8">
  <!-- Header -->
  <div class="text-center mb-16">
    <h2 class="text-4xl font-bold text-white mb-4">Pricing</h2>
    <p class="text-xl text-neutral-300 mb-8">Start for free. Upgrade as you go.</p>
  </div>

  <!-- Pricing Cards -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
    <!-- Tajir Trial -->
    <div class="pricing-card">
      <div class="card-content">
        <div class="text-center">
          <h3 class="text-xl font-semibold text-white mb-2">Tajir Trial</h3>
          <div class="mb-6">
            <span class="text-3xl font-bold text-white">Free</span>
            <span class="text-neutral-400">30 days</span>
            <div>Full PRO features</div>
            <span class="text-neutral-400"> No payment required</span>
          </div>
        </div>
        <div class="features-section space-y-4">
          <div class="flex items-center">
            <svg data-lucide="check" class="w-5 h-5 feature-check"></svg>
            <span class="text-neutral-300">Billing</span>
          </div>
          <div class="flex items-center">
            <svg data-lucide="check" class="w-5 h-5 feature-check"></svg>
            <span class="text-neutral-300">Product Management</span>
          </div>
          <div class="flex items-center">
            <svg data-lucide="check" class="w-5 h-5 feature-check"></svg>
            <span class="text-neutral-300">Customer Management</span>
          </div>
          <div class="flex items-center">
            <svg data-lucide="check" class="w-5 h-5 feature-check"></svg>
            <span class="text-neutral-300">Dashboard</span>
          </div>
          <div class="flex items-center">
            <svg data-lucide="check" class="w-5 h-5 feature-check"></svg>
            <span class="text-neutral-300">Customer Search</span>
          </div>
          <div class="flex items-center">
            <svg data-lucide="check" class="w-5 h-5 feature-check"></svg>
            <span class="text-neutral-300">Data backup/Restore</span>
          </div>
          <div class="flex items-center">
            <svg data-lucide="check" class="w-5 h-5 feature-check"></svg>
            <span class="text-neutral-300">WhatsApp Bill</span>
          </div>
          
          <!-- Upcoming Features Section -->
          <!--
          <div class="border-t border-neutral-700 pt-4 mt-4">
            <h4 class="text-sm font-semibold text-indigo-400 mb-3 text-center">Upcoming Features</h4>
            <div class="space-y-2">
              <div class="flex items-center">
                <svg data-lucide="check" class="w-4 h-4 feature-check"></svg>
                <span class="text-xs text-neutral-400">Advanced reporting and analytics</span>
              </div>
              <div class="flex items-center">
                <svg data-lucide="check" class="w-4 h-4 feature-check"></svg>
                <span class="text-xs text-neutral-400">Mobile App integration</span>
              </div>
              <div class="flex items-center">
                <svg data-lucide="check" class="w-4 h-4 feature-check"></svg>
                <span class="text-xs text-neutral-400">Payment gateway integration</span>
              </div>
              <div class="flex items-center">
                <svg data-lucide="check" class="w-4 h-4 feature-check"></svg>
                <span class="text-xs text-neutral-400">Inventory management</span>
              </div>
            </div>
          </div>
          -->
        </div>
      </div>
      <div class="btn-container">
        <button onclick="selectPlan('trial')" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg px-6 py-3 font-semibold transition-colors">
          Get started
        </button>
      </div>
    </div>

    <!-- Tajir Basic -->
    <div class="pricing-card popular relative">
      <div class="popular-badge" align="center">Popular</div>
      <div class="card-content">
        <div class="text-center">
          <h3 class="text-xl font-semibold text-white mb-2">Tajir Basic</h3>
          <div class="mb-6">
            <span class="text-3xl font-bold text-white">AED 499</span>
            <span class="text-sm text-neutral-500 block">Annual Subscription</span>
          </div>
        </div>
        <div class="features-section space-y-4">
          <div class="flex items-center">
            <svg data-lucide="check" class="w-5 h-5 feature-check"></svg>
            <span class="text-neutral-300">Billing</span>
          </div>
          <div class="flex items-center">
            <svg data-lucide="check" class="w-5 h-5 feature-check"></svg>
            <span class="text-neutral-300">Product Management</span>
          </div>
          <div class="flex items-center">
            <svg data-lucide="check" class="w-5 h-5 feature-check"></svg>
            <span class="text-neutral-300">Customer Management</span>
          </div>
          <div class="flex items-center">
            <svg data-lucide="lock" class="w-5 h-5 feature-lock"></svg>
            <span class="text-neutral-500">Dashboard</span>
          </div>
          <div class="flex items-center">
            <svg data-lucide="lock" class="w-5 h-5 feature-lock"></svg>
            <span class="text-neutral-500">Customer Search</span>
          </div>
          <div class="flex items-center">
            <svg data-lucide="lock" class="w-5 h-5 feature-lock"></svg>
            <span class="text-neutral-500">Data backup/Restore</span>
          </div>
          <div class="flex items-center">
            <svg data-lucide="check" class="w-5 h-5 feature-check"></svg>
            <span class="text-neutral-300">WhatsApp Bill</span>
          </div>
          
          <!-- Upcoming Features Section -->
          <!--
          <div class="border-t border-neutral-700 pt-4 mt-4">
            <h4 class="text-sm font-semibold text-red-400 mb-3 text-center">Upcoming Features: Locked</h4>
            <div class="space-y-2">
              <div class="flex items-center">
                <svg data-lucide="lock" class="w-4 h-4 feature-lock"></svg>
                <span class="text-xs text-neutral-500">Advanced reporting and analytics</span>
              </div>
              <div class="flex items-center">
                <svg data-lucide="lock" class="w-4 h-4 feature-lock"></svg>
                <span class="text-xs text-neutral-500">Mobile App integration</span>
              </div>
              <div class="flex items-center">
                <svg data-lucide="lock" class="w-4 h-4 feature-lock"></svg>
                <span class="text-xs text-neutral-500">Payment gateway integration</span>
              </div>
              <div class="flex items-center">
                <svg data-lucide="lock" class="w-4 h-4 feature-lock"></svg>
                <span class="text-xs text-neutral-500">Inventory management</span>
              </div>
            </div>
          </div>
          -->
        </div>
      </div>
      <div class="btn-container">
        <button onclick="selectPlan('basic')" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg px-6 py-3 font-semibold transition-colors">
          Get started
        </button>
      </div>
    </div>

    <!-- Tajir PRO -->
    <div class="pricing-card">
      <div class="card-content">
        <div class="text-center">
          <h3 class="text-xl font-semibold text-white mb-2">Tajir PRO</h3>
          <div class="mb-6">
            <span class="text-3xl font-bold text-white">AED 899</span>
            <span class="text-sm text-neutral-500 block">Annual subscription</span>
            <div>&nbsp</div>
          </div>
        </div>
        <div class="features-section space-y-4">
          <div class="flex items-center">
            <svg data-lucide="check" class="w-5 h-5 feature-check"></svg>
            <span class="text-neutral-300">Everything in Basic</span>
          </div>
          <div class="flex items-center">
            <svg data-lucide="check" class="w-5 h-5 feature-check"></svg>
            <span class="text-neutral-300">EmaraTax API Integration</span>
          </div>
          <div class="flex items-center">
            <svg data-lucide="check" class="w-5 h-5 feature-check"></svg>
            <span class="text-neutral-300">Real-time invoice validation</span>
          </div>
          <div class="flex items-center">
            <svg data-lucide="check" class="w-5 h-5 feature-check"></svg>
            <span class="text-neutral-300">Digital signature management</span>
          </div>
          <div class="flex items-center">
            <svg data-lucide="check" class="w-5 h-5 feature-check"></svg>
            <span class="text-neutral-300">VAT return reports (VAT 201)</span>
          </div>
          <div class="flex items-center">
            <svg data-lucide="check" class="w-5 h-5 feature-check"></svg>
            <span class="text-neutral-300">Bulk invoice upload/download</span>
          </div>
          <div class="flex items-center">
            <svg data-lucide="check" class="w-5 h-5 feature-check"></svg>
            <span class="text-neutral-300">Branch-wise TRN configuration</span>
          </div>
          <div class="flex items-center">
            <svg data-lucide="check" class="w-5 h-5 feature-check"></svg>
            <span class="text-neutral-300">Priority support</span>
          </div>
          
          <!-- Upcoming Features Section -->
          <!--
          <div class="border-t border-neutral-700 pt-4 mt-4">
            <h4 class="text-sm font-semibold text-indigo-400 mb-3 text-center">Upcoming Features</h4>
            <div class="space-y-2">
              <div class="flex items-center">
                <svg data-lucide="check" class="w-4 h-4 feature-check"></svg>
                <span class="text-xs text-neutral-400">Advanced reporting and analytics</span>
              </div>
              <div class="flex items-center">
                <svg data-lucide="check" class="w-4 h-4 feature-check"></svg>
                <span class="text-xs text-neutral-400">Mobile App integration</span>
              </div>
              <div class="flex items-center">
                <svg data-lucide="check" class="w-4 h-4 feature-check"></svg>
                <span class="text-xs text-neutral-400">Payment gateway integration</span>
              </div>
              <div class="flex items-center">
                <svg data-lucide="check" class="w-4 h-4 feature-check"></svg>
                <span class="text-xs text-neutral-400">Inventory management</span>
              </div>
            </div>
          </div>
          -->
        </div>
      </div>
      <div class="btn-container">
        <button onclick="selectPlan('pro')" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg px-6 py-3 font-semibold transition-colors">
          Get started
        </button>
      </div>
    </div>

    <!-- Enterprise -->
    <div class="pricing-card">
      <div class="card-content">
        <div class="text-center">
          <h3 class="text-xl font-semibold text-white mb-2">Enterprise</h3>
          <div class="mb-6">
            <span class="text-3xl font-bold text-white">Custom</span>
          </div>
        </div>
        <div class="features-section space-y-4">
          <p class="text-sm text-neutral-400 mb-4 text-center">Everything in PRO, plus:</p>
          <div class="flex items-center">
            <svg data-lucide="check" class="w-5 h-5 feature-check"></svg>
            <span class="text-neutral-300">User authentication and role-based access</span>
          </div>
          <div class="flex items-center">
            <svg data-lucide="check" class="w-5 h-5 feature-check"></svg>
            <span class="text-neutral-300">Inventory management</span>
          </div>
          <div class="flex items-center">
            <svg data-lucide="check" class="w-5 h-5 feature-check"></svg>
            <span class="text-neutral-300">Customer loyalty program</span>
          </div>
          <div class="flex items-center">
            <svg data-lucide="check" class="w-5 h-5 feature-check"></svg>
            <span class="text-neutral-300">Multi-branch support</span>
          </div>
          <div class="flex items-center">
            <svg data-lucide="check" class="w-5 h-5 feature-check"></svg>
            <span class="text-neutral-300">Advanced reporting and analytics</span>
          </div>
          <div class="flex items-center">
            <svg data-lucide="check" class="w-5 h-5 feature-check"></svg>
            <span class="text-neutral-300">Mobile app integration</span>
          </div>
          <div class="flex items-center">
            <svg data-lucide="check" class="w-5 h-5 feature-check"></svg>
            <span class="text-neutral-300">Payment gateway integration</span>
          </div>
        </div>
      </div>
      <div class="btn-container">
        <button onclick="selectPlan('enterprise')" class="w-full bg-neutral-700 hover:bg-neutral-600 text-white rounded-lg px-6 py-3 font-semibold transition-colors">
          Ask for a quote
        </button>
      </div>
    </div>
  </div>

  <!-- FAQ Section -->
  <div class="mt-20 text-center">
    <h2 class="text-3xl font-bold text-white mb-8">Frequently Asked Questions</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-4xl mx-auto">
      <div class="text-left">
        <h3 class="text-lg font-semibold text-white mb-2">Can I change plans anytime?</h3>
        <p class="text-neutral-400">Yes, you can upgrade or downgrade your plan at any time. Changes take effect immediately.</p>
      </div>
      <div class="text-left">
        <h3 class="text-lg font-semibold text-white mb-2">Is there a free trial?</h3>
        <p class="text-neutral-400">Yes, you can try our Pro plan free for 15 days. No credit card required.</p>
      </div>
      <div class="text-left">
        <h3 class="text-lg font-semibold text-white mb-2">What payment methods do you accept?</h3>
        <p class="text-neutral-400">We accept all major credit cards, PayPal, and bank transfers for Enterprise plans.</p>
      </div>
      <div class="text-left">
        <h3 class="text-lg font-semibold text-white mb-2">Do you offer refunds?</h3>
        <p class="text-neutral-400">We offer a 30-day money-back guarantee for all paid plans.</p>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://js.stripe.com/v3/"></script>
<script>
  // Initialize Stripe
  let stripe, elements, cardElement;
  let currentPlanId = null;
  let paymentIntentClientSecret = null;

  document.addEventListener('DOMContentLoaded', function() {
    lucide.createIcons();
    initializeStripe();
  });

  async function initializeStripe() {
    try {
      // Get Stripe publishable key from backend
      const response = await fetch('/api/subscription/stripe-key');
      const data = await response.json();
      
      if (data.publishable_key) {
        stripe = Stripe(data.publishable_key);
        elements = stripe.elements();
        cardElement = elements.create('card', {
          style: {
            base: {
              fontSize: '16px',
              color: '#ffffff',
              '::placeholder': {
                color: '#9ca3af',
              },
            },
          },
        });
      } else {
        console.warn('Stripe not configured - payment features disabled');
      }
    } catch (error) {
      console.error('Error initializing Stripe:', error);
    }
  }

  async function selectPlan(planType) {
    if (planType === 'trial') {
      // Handle trial signup
      showToast('Trial started! You can use all features for 30 days.', 'success');
      return;
    }

    if (planType === 'enterprise') {
      // Handle enterprise contact
      window.open('mailto:sales@tajirtech.com?subject=Enterprise Plan Inquiry', '_blank');
      return;
    }

    try {
      // Map plan types to plan IDs
      const planMap = {
        'basic': 2,
        'pro': 3
      };

      const planId = planMap[planType];
      if (!planId) {
        showToast('Invalid plan selected', 'error');
        return;
      }

      // Create payment intent
      const response = await fetch('/api/subscription/create-payment-intent', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          plan_id: planId,
          billing_cycle: 'yearly'
        })
      });

      const data = await response.json();

      if (data.error) {
        showToast('Error: ' + data.error, 'error');
        return;
      }

      // Store payment details
      currentPlanId = planId;
      paymentIntentClientSecret = data.client_secret;

      // Show payment modal
      showPaymentModal(data.amount, data.currency);

    } catch (error) {
      console.error('Error creating payment intent:', error);
      showToast('Error creating payment. Please try again.', 'error');
    }
  }

  function showPaymentModal(amount, currency) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center';
    modal.innerHTML = `
      <div class="bg-neutral-900 border border-neutral-700 rounded-xl p-8 max-w-md w-full mx-4">
        <div class="text-center mb-6">
          <div class="w-16 h-16 bg-indigo-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
            </svg>
          </div>
          <h3 class="text-xl font-semibold text-white mb-2">Complete Payment</h3>
          <p class="text-neutral-400">Amount: ${currency} ${amount}</p>
        </div>
        
        <div id="card-element" class="border border-neutral-600 rounded-lg p-3 mb-4 bg-neutral-800">
          <!-- Stripe Elements will create form elements here -->
        </div>
        <div id="card-errors" class="text-red-500 mb-4 text-sm"></div>
        
        <div class="flex gap-3">
          <button id="submit-payment" class="flex-1 bg-indigo-600 hover:bg-indigo-500 text-white py-3 rounded-lg font-medium transition-colors">
            Pay Now
          </button>
          <button onclick="closePaymentModal()" class="flex-1 bg-neutral-700 hover:bg-neutral-600 text-white py-3 rounded-lg font-medium transition-colors">
            Cancel
          </button>
        </div>
      </div>
    `;

    document.body.appendChild(modal);

    // Mount Stripe Elements
    if (cardElement) {
      cardElement.mount('#card-element');
      
      cardElement.on('change', (event) => {
        const displayError = document.getElementById('card-errors');
        if (event.error) {
          displayError.textContent = event.error.message;
        } else {
          displayError.textContent = '';
        }
      });
    }

    // Add submit handler
    document.getElementById('submit-payment').addEventListener('click', submitPayment);
  }

  async function submitPayment() {
    const submitButton = document.getElementById('submit-payment');
    submitButton.disabled = true;
    submitButton.textContent = 'Processing...';

    try {
      const {error, paymentIntent} = await stripe.confirmCardPayment(
        paymentIntentClientSecret,
        {
          payment_method: {
            card: cardElement,
          }
        }
      );

      if (error) {
        document.getElementById('card-errors').textContent = error.message;
        submitButton.disabled = false;
        submitButton.textContent = 'Pay Now';
      } else {
        // Payment succeeded
        await confirmSubscription(paymentIntent.id);
      }
    } catch (err) {
      console.error('Error:', err);
      showToast('Payment failed. Please try again.', 'error');
      submitButton.disabled = false;
      submitButton.textContent = 'Pay Now';
    }
  }

  async function confirmSubscription(paymentIntentId) {
    try {
      const response = await fetch('/api/subscription/confirm', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          payment_intent_id: paymentIntentId,
          plan_id: currentPlanId,
          billing_cycle: 'yearly'
        })
      });

      const data = await response.json();

      if (data.success) {
        showToast('Subscription activated successfully!', 'success');
        closePaymentModal();
        // Redirect to app after successful payment
        setTimeout(() => {
          window.location.href = '/app';
        }, 2000);
      } else {
        showToast('Error: ' + data.error, 'error');
      }
    } catch (error) {
      console.error('Error confirming subscription:', error);
      showToast('Error confirming subscription. Please contact support.', 'error');
    }
  }

  function closePaymentModal() {
    const modal = document.querySelector('.fixed.inset-0.bg-black\\/50');
    if (modal) {
      modal.remove();
    }
  }

  function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg font-medium transition-all duration-300 transform translate-x-full`;
    
    const colors = {
      success: 'bg-green-600 text-white',
      error: 'bg-red-600 text-white',
      warning: 'bg-orange-600 text-white',
      info: 'bg-blue-600 text-white'
    };
    
    toast.classList.add(colors[type] || colors.info);
    toast.textContent = message;
    
    document.body.appendChild(toast);
    
    // Animate in
    setTimeout(() => {
      toast.classList.remove('translate-x-full');
    }, 100);
    
    // Animate out and remove
    setTimeout(() => {
      toast.classList.add('translate-x-full');
      setTimeout(() => {
        toast.remove();
      }, 300);
    }, 3000);
  }
</script>
{% endblock %} 